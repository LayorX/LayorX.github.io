<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase é€²éšæ•¸æ“šå„€è¡¨æ¿ v2</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Chart.js ç”¨æ–¼ç¹ªè£½åœ–è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        .data-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .data-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .sortable:hover { background-color: #f9fafb; cursor: pointer; }
        .sort-asc::after { content: ' â–²'; }
        .sort-desc::after { content: ' â–¼'; }
        #user-detail-modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-xl shadow-lg">
            <div>
                <svg class="mx-auto h-12 w-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 17.54a2.5 2.5 0 0 0-2.35-2.46l-2.35-2.46A2.5 2.5 0 0 0 13 10.14V8a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2.14a2.5 2.5 0 0 0-2.3 2.46l-2.35-2.46A2.5 2.5 0 0 0 4 20h16a2.5 2.5 0 0 0-.2-2.46Z"/><path d="M12 2v4"/><path d="M12 12h.01"/></svg>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">å„€è¡¨æ¿ç™»å…¥</h2>
            </div>
            <div class="mt-8 space-y-6">
                <div id="login-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"><strong class="font-bold">éŒ¯èª¤ï¼š</strong><span id="login-error-message"></span></div>
                <button id="login-button" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">ç™»å…¥</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å„€è¡¨æ¿ç•«é¢ -->
    <div id="dashboard-screen" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16"><div class="flex items-center space-x-4"><svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 17.54a2.5 2.5 0 0 0-2.35-2.46l-2.35-2.46A2.5 2.5 0 0 0 13 10.14V8a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2.14a2.5 2.5 0 0 0-2.3 2.46l-2.35-2.46A2.5 2.5 0 0 0 4 20h16a2.5 2.5 0 0 0-.2-2.46Z"/><path d="M12 2v4"/><path d="M12 12h.01"/></svg><h1 class="text-2xl font-bold text-gray-900">æ•¸æ“šå„€è¡¨æ¿</h1></div><div class="flex items-center space-x-4"><div class="text-sm text-gray-600"><p>ä½¿ç”¨è€…: <span id="user-email" class="font-semibold"></span></p></div><button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">ç™»å‡º</button></div></div>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <!-- [FIX] Global Notification Area -->
            <div id="global-notifications" class="mb-4"></div>

            <div class="mb-6 border-b border-gray-200"><nav class="flex space-x-2 sm:space-x-4" aria-label="Tabs"><button class="tab-button active font-semibold py-3 px-2 sm:px-4 border-b-2 rounded-t-lg" data-tab="overview">æ•¸æ“šç¸½è¦½</button><button class="tab-button font-semibold py-3 px-2 sm:px-4 border-b-2 rounded-t-lg" data-tab="user-analysis">ç”¨æˆ¶åˆ†æ</button><button class="tab-button font-semibold py-3 px-2 sm:px-4 border-b-2 rounded-t-lg" data-tab="content-analysis">å…§å®¹åˆ†æ</button></nav></div>

            <div>
                <!-- æ•¸æ“šç¸½è¦½åˆ†é  -->
                <div id="tab-overview" class="tab-content active space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4 md:gap-6">
                        <div class="bg-white p-4 rounded-xl shadow-md data-card"><p class="text-sm text-gray-500">ç¸½ç”¨æˆ¶æ•¸</p><p id="total-users" class="text-2xl md:text-3xl font-bold text-indigo-600">0</p></div>
                        <div class="bg-white p-4 rounded-xl shadow-md data-card"><p class="text-sm text-gray-500">ç¸½åˆ†äº«æ•¸</p><p id="total-shares" class="text-2xl md:text-3xl font-bold text-indigo-600">0</p></div>
                        <div class="bg-white p-4 rounded-xl shadow-md data-card"><p class="text-sm text-gray-500">æ¯ç”¨æˆ¶å¹³å‡åˆ†äº«</p><p id="avg-shares-per-user" class="text-2xl md:text-3xl font-bold text-indigo-600">0</p></div>
                        <div class="bg-white p-4 rounded-xl shadow-md data-card"><p class="text-sm text-gray-500">æ¯åˆ†äº«å¹³å‡ç²è®š</p><p id="avg-likes-per-share" class="text-2xl md:text-3xl font-bold text-indigo-600">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md data-card"><h3 class="text-lg font-semibold mb-4">è¿‘ 7 æ—¥åˆ†äº«è¶¨å‹¢</h3><div class="relative h-80"><canvas id="daily-shares-chart"></canvas></div></div>
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md data-card"><h3 class="text-lg font-semibold mb-4">24H æ´»èºç”¨æˆ¶çµ„æˆ</h3><div class="relative h-32"><canvas id="active-user-composition-chart"></canvas></div></div>
                            <div class="bg-white p-6 rounded-xl shadow-md data-card"><h3 class="text-lg font-semibold mb-4">å…§å®¹æƒ…æ„Ÿåˆ†æ</h3><div class="relative h-32"><canvas id="sentiment-chart"></canvas></div></div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ¶åˆ†æåˆ†é  -->
                <div id="tab-user-analysis" class="tab-content space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md data-card">
                        <h2 class="text-xl font-bold mb-4">å…¨ç”¨æˆ¶çµ±è¨ˆ</h2>
                        <div class="mb-4"><input type="text" id="user-search-input" placeholder="ä¾ä½¿ç”¨è€… UID æœå°‹..." class="w-full md:w-1/3 p-2 border rounded-lg"></div>
                        <div class="max-h-[40rem] overflow-auto"><table id="stats-table" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable" data-sort="id">ä½¿ç”¨è€… UID</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable" data-sort="engagementScore">åƒèˆ‡åº¦è©•åˆ†</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable" data-sort="shares">åˆ†äº«</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable" data-sort="likes">è®š</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable" data-sort="gachaDraws">æŠ½å¡</th><th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider sortable" data-sort="lastLogin">æœ€å¾Œç™»å…¥</th></tr></thead><tbody id="stats-table-body" class="bg-white divide-y divide-gray-200"></tbody></table><div id="stats-loader" class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div></div></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md data-card">
                        <h2 class="text-xl font-bold mb-4">ä½æ´»èº / æµå¤±é¢¨éšªç”¨æˆ¶</h2>
                        <p class="text-sm text-gray-500 mb-4">é€™äº›ç”¨æˆ¶å·²ç™»å…¥ä½†å¹¾ä¹æ²’æœ‰äº’å‹•ï¼Œå¯é—œæ³¨å…¶å¾ŒçºŒè¡Œç‚ºã€‚</p>
                        <div id="silent-users-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- å…§å®¹åˆ†æåˆ†é  -->
                <div id="tab-content-analysis" class="tab-content space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md data-card"><h2 class="text-xl font-bold mb-4">åˆ†äº«æ’è¡Œæ¦œ</h2><div class="flex justify-around bg-indigo-50 p-3 rounded-lg mb-4 text-center"><div><p class="text-2xl font-bold text-indigo-600" id="total-sharers">0</p><p class="text-xs text-gray-500">åˆ†äº«ç”¨æˆ¶æ•¸</p></div><div><p class="text-2xl font-bold text-indigo-600" id="total-shared-photos">0</p><p class="text-xs text-gray-500">ç¸½åˆ†äº«ç…§ç‰‡</p></div></div><div id="shared-by-loader" class="text-center py-8"><div class="animate-spin h-8 w-8 border-b-2 border-indigo-500 mx-auto"></div></div><div id="shared-by-list" class="space-y-3 max-h-96 overflow-y-auto"></div></div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md data-card"><h2 class="text-xl font-bold mb-4">å…§å®¹æ´å¯Ÿ</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1"><h3 class="font-semibold mb-2">æœ€è¿‘åˆ†äº«</h3><div id="recent-shares-list" class="space-y-2 max-h-96 overflow-y-auto"></div></div><div><h3 class="font-semibold mb-2">ğŸ‘ Top 5 æœ€å¤šè®š</h3><div id="top-liked-list" class="space-y-2"></div></div><div><h3 class="font-semibold mb-2">ğŸ‘ Top 5 æœ€å¤šå€’è®š</h3><div id="top-disliked-list" class="space-y-2"></div></div></div></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md data-card">
                        <h3 class="text-lg font-semibold mb-4">ç†±é–€åˆ†äº«æ™‚æ®µ (UTC)</h3>
                        <div class="relative h-80"><canvas id="hourly-shares-chart"></canvas></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="user-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden items-center justify-center p-4" onclick="this.classList.add('hidden')"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto p-6" onclick="event.stopPropagation()"><h3 class="text-xl font-bold mb-4">ç”¨æˆ¶è©³ç´°æ•¸æ“š</h3><pre id="user-detail-content" class="bg-gray-100 p-4 rounded text-sm whitespace-pre-wrap break-all"></pre><button id="close-modal-button" class="mt-4 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">é—œé–‰</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, collectionGroup, query } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDbWa8TWru1J048WK8msVBaC9JhhhtuhJw", authDomain: "goddess-chance.firebaseapp.com", projectId: "goddess-chance", storageBucket: "goddess-chance.appspot.com", messagingSenderId: "440990936442", appId: "1:440990936442:web:37d864cd13112f14913ac3" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements & State ---
        const loginScreen = document.getElementById('login-screen'), dashboardScreen = document.getElementById('dashboard-screen');
        const userEmail = document.getElementById('user-email'), userSearchInput = document.getElementById('user-search-input');
        const modal = document.getElementById('user-detail-modal'), modalContent = document.getElementById('user-detail-content');
        const notificationArea = document.getElementById('global-notifications');
        let dailySharesChart, sentimentChart, activeUserCompChart, hourlySharesChart;
        let allStatsData = [], currentSort = { key: 'engagementScore', order: 'desc' }, unsubscribes = [];

        // --- Initialization ---
        function initCharts() {
            [dailySharesChart, sentimentChart, activeUserCompChart, hourlySharesChart].forEach(chart => chart?.destroy());
            dailySharesChart = new Chart(document.getElementById('daily-shares-chart').getContext('2d'), { type: 'bar', options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
            sentimentChart = new Chart(document.getElementById('sentiment-chart').getContext('2d'), { type: 'doughnut', options: { responsive: true, maintainAspectRatio: false } });
            activeUserCompChart = new Chart(document.getElementById('active-user-composition-chart').getContext('2d'), { type: 'doughnut', options: { responsive: true, maintainAspectRatio: false } });
            hourlySharesChart = new Chart(document.getElementById('hourly-shares-chart').getContext('2d'), { type: 'bar', options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }

        // --- Event Listeners ---
        document.querySelectorAll('.tab-button').forEach(tab => tab.addEventListener('click', e => {
            document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById(`tab-${e.target.dataset.tab}`).classList.add('active');
        }));
        onAuthStateChanged(auth, user => {
            if (user) {
                loginScreen.classList.add('hidden'); dashboardScreen.classList.remove('hidden'); userEmail.textContent = user.email;
                notificationArea.innerHTML = ''; // Clear notifications on login
                initCharts(); listenToData();
            } else {
                loginScreen.classList.remove('hidden'); dashboardScreen.classList.add('hidden');
                unsubscribes.forEach(unsub => unsub()); unsubscribes = [];
            }
        });
        document.getElementById('login-button').addEventListener('click', () => signInWithEmailAndPassword(auth, 'GoddeSpark2025@gmail.com', '123!@#').catch(e => alert(`ç™»å…¥å¤±æ•—: ${e.message}`)));
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        userSearchInput.addEventListener('input', e => renderStatisticsTable(allStatsData.filter(doc => doc.id.toLowerCase().includes(e.target.value.toLowerCase()))));
        
        const statsTableThead = document.getElementById('stats-table')?.querySelector('thead');
        if (statsTableThead) {
            statsTableThead.addEventListener('click', e => {
                const th = e.target.closest('th[data-sort]');
                if (!th) return;
                const sortKey = th.dataset.sort;
                currentSort.order = (currentSort.key === sortKey && currentSort.order === 'asc') ? 'desc' : 'asc';
                currentSort.key = sortKey;
                renderStatisticsTable(allStatsData);
            });
        }
        document.getElementById('close-modal-button').addEventListener('click', () => modal.classList.add('hidden'));

        // --- Data Listeners ---
        function listenToData() {
            unsubscribes.forEach(unsub => unsub()); unsubscribes = [];
            
            const unsubGoddesses = onSnapshot(query(collection(db, 'public-goddesses')), snapshot => {
                notificationArea.innerHTML = ''; // Clear previous errors on success
                const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateContentAnalysis(docs);
                updateDailySharesChart(docs);
                updateHourlySharesChart(docs);
                const totalLikes = docs.reduce((sum, d) => sum + (d.likeCount || 0), 0);
                document.getElementById('total-shares').textContent = snapshot.size;
                document.getElementById('avg-likes-per-share').textContent = snapshot.size > 0 ? (totalLikes / snapshot.size).toFixed(2) : 0;
            }, error => {
                console.error("ç›£è½ public-goddesses å¤±æ•—:", error);
                showPermissionError('public-goddesses');
            });

            const unsubStats = onSnapshot(query(collectionGroup(db, 'statistics')), snapshot => {
                notificationArea.innerHTML = ''; // Clear previous errors on success
                allStatsData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const engagementScore = (data.shares || 0) * 5 + (data.likes || 0);
                    return { id: doc.ref.parent.parent.id, engagementScore, ...data };
                });
                updateOverviewCards(allStatsData);
                renderStatisticsTable(allStatsData);
                updateSilentUsersList(allStatsData);
                document.getElementById('stats-loader').style.display = 'none';
            }, error => {
                console.error("ç›£è½ statistics é›†åˆçµ„å¤±æ•—:", error);
                showPermissionError('statistics');
                document.getElementById('stats-loader').style.display = 'none';
            });
            unsubscribes.push(unsubGoddesses, unsubStats);
        }

        // --- UI Update & Helper Functions ---
        function showPermissionError(collectionName) {
            let ruleSnippet = `// è¦å‰‡ç¯„ä¾‹: å…è¨±å·²ç™»å…¥ç”¨æˆ¶è®€å–
match /${collectionName}/{docId} {
  allow read: if request.auth != null;
}`;
            if (collectionName === 'statistics') {
                ruleSnippet = `// é›†åˆçµ„æŸ¥è©¢éœ€è¦æ­¤ç‰¹æ®Šè¦å‰‡
match /{path=**}/statistics/{statId} {
  allow read: if request.auth != null;
}`;
            }
            notificationArea.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                    <p class="font-bold">æ¬Šé™éŒ¯èª¤ï¼</p>
                    <p>ç„¡æ³•è®€å– '${collectionName}' æ•¸æ“šã€‚é€™é€šå¸¸æ˜¯å› ç‚ºç¼ºå°‘å°æ‡‰çš„ Firestore å®‰å…¨è¦å‰‡ã€‚</p>
                    <p class="mt-2">è«‹å‰å¾€æ‚¨çš„ Firebase æ§åˆ¶å° -> Firestore -> è¦å‰‡ï¼Œä¸¦åŠ å…¥ä»¥ä¸‹è¦å‰‡ï¼š</p>
                    <pre class="bg-gray-800 text-white p-2 rounded mt-2 text-xs"><code>${ruleSnippet}</code></pre>
                </div>`;
        }
        
        function updateOverviewCards(stats) {
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const activeUsers = stats.filter(s => s.lastLogin?.toDate() > twentyFourHoursAgo);
            const newActiveUsers = activeUsers.filter(s => s.createdAt?.toDate() > sevenDaysAgo).length;
            
            document.getElementById('total-users').textContent = stats.length;
            document.getElementById('avg-shares-per-user').textContent = stats.length > 0 ? (stats.reduce((sum, s) => sum + (s.shares || 0), 0) / stats.length).toFixed(2) : 0;
            
            activeUserCompChart.data.labels = ['æ—¢æœ‰ç”¨æˆ¶', 'æ–°ç”¨æˆ¶'];
            activeUserCompChart.data.datasets = [{ data: [activeUsers.length - newActiveUsers, newActiveUsers], backgroundColor: ['#4f46e5', '#818cf8'] }];
            activeUserCompChart.update();
        }

        function updateContentAnalysis(docs) {
            // Leaderboard
            const sharedByCount = docs.reduce((acc, doc) => { if(doc.sharedBy) acc[doc.sharedBy] = (acc[doc.sharedBy] || 0) + 1; return acc; }, {});
            const listEl = document.getElementById('shared-by-list');
            listEl.innerHTML = '';
            document.getElementById('total-sharers').textContent = Object.keys(sharedByCount).length;
            document.getElementById('total-shared-photos').textContent = docs.length;
            const sortedSharers = Object.entries(sharedByCount).sort(([, a], [, b]) => b - a);
            sortedSharers.forEach(([userId, count], i) => {
                const rank = i + 1, icon = rank === 1 ? 'ğŸ†' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
                listEl.innerHTML += `<div class="p-3 rounded-lg flex items-center justify-between ${rank === 1 ? 'bg-yellow-100' : 'bg-gray-50'}"><div class="flex items-center gap-2"><span class="font-bold text-lg w-6 text-center">${icon}</span><span class="font-mono text-xs truncate" title="${userId}">${userId}</span></div><span class="font-bold text-lg">${count} æ¬¡</span></div>`;
            });
            document.getElementById('shared-by-loader').style.display = 'none';

            // Recent, Top Liked/Disliked & Sentiment Chart
            const recentList = document.getElementById('recent-shares-list'), topLikedList = document.getElementById('top-liked-list'), topDislikedList = document.getElementById('top-disliked-list');
            recentList.innerHTML = topLikedList.innerHTML = topDislikedList.innerHTML = '';
            docs.sort((a,b) => b.createdAt?.toMillis() - a.createdAt?.toMillis()).slice(0, 10).forEach(doc => recentList.innerHTML += `<div class="p-2 bg-gray-50 rounded text-xs"><b>ID:</b> ${doc.id.substring(0,8)}...<br><b>By:</b> ${doc.sharedBy?.substring(0,8) || 'N/A'}...</div>`);
            docs.sort((a,b) => (b.likeCount || 0) - (a.likeCount || 0)).slice(0, 5).forEach(doc => topLikedList.innerHTML += `<div class="p-2 bg-green-50 rounded text-xs"><b>ID:</b> ${doc.id.substring(0,8)}... (ğŸ‘ ${doc.likeCount || 0})</div>`);
            docs.sort((a,b) => (b.dislikeCount || 0) - (a.dislikeCount || 0)).slice(0, 5).forEach(doc => topDislikedList.innerHTML += `<div class="p-2 bg-red-50 rounded text-xs"><b>ID:</b> ${doc.id.substring(0,8)}... (ğŸ‘ ${doc.dislikeCount || 0})</div>`);
            sentimentChart.data.labels = ['ç¸½è®šæ•¸', 'ç¸½å€’è®šæ•¸'];
            sentimentChart.data.datasets = [{ data: [docs.reduce((s, d) => s + (d.likeCount || 0), 0), docs.reduce((s, d) => s + (d.dislikeCount || 0), 0)], backgroundColor: ['#34d399', '#f87171'] }];
            sentimentChart.update();
        }
        
        function updateSilentUsersList(stats) {
            const silentUsers = stats.filter(s => (s.shares || 0) === 0 && (s.likes || 0) === 0 && (s.gachaDraws || 0) === 0);
            const listEl = document.getElementById('silent-users-list');
            listEl.innerHTML = silentUsers.length > 0 ? '' : '<p class="text-gray-500">æ²’æœ‰æ‰¾åˆ°ä½æ´»èºç”¨æˆ¶ã€‚</p>';
            silentUsers.slice(0, 10).forEach(user => listEl.innerHTML += `<div class="p-2 bg-gray-100 rounded font-mono text-xs">${user.id}</div>`);
        }
        
        function renderStatisticsTable(stats) {
            const { key, order } = currentSort;
            const sorted = [...stats].sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (key === 'lastLogin') { valA = valA?.toMillis() || 0; valB = valB?.toMillis() || 0; }
                valA = valA || (key === 'id' ? '' : 0); valB = valB || (key === 'id' ? '' : 0);
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            const powerUserThreshold = sorted.length > 10 ? sorted[Math.floor(sorted.length * 0.1)].engagementScore : 0;
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';
            document.querySelectorAll('#stats-table th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
            document.querySelector(`#stats-table th[data-sort="${key}"]`).classList.add(order === 'asc' ? 'sort-asc' : 'sort-desc');

            sorted.forEach(doc => {
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-50';
                row.onclick = () => { modalContent.textContent = JSON.stringify(doc, null, 2); modal.classList.add('flex'); };
                const isPowerUser = doc.engagementScore > 0 && doc.engagementScore >= powerUserThreshold;
                row.innerHTML = `<td class="p-4"><div class="font-mono text-xs">${doc.id} ${isPowerUser ? 'ğŸ”¥' : ''}</div></td><td class="p-4 font-bold">${doc.engagementScore.toFixed(0)}</td><td class="p-4">${doc.shares||0}</td><td class="p-4">${doc.likes||0}</td><td class="p-4">${doc.gachaDraws||0}</td><td class="p-4 text-xs">${doc.lastLogin?.toDate ? doc.lastLogin.toDate().toLocaleString('zh-TW') : 'N/A'}</td>`;
                tableBody.appendChild(row);
            });
        }

        function updateDailySharesChart(docs) {
            const dailyData = {}, labels = [];
            for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); labels.push(d.toISOString().split('T')[0]); }
            labels.forEach(l => dailyData[l] = 0);
            docs.forEach(doc => { if(doc.createdAt?.toDate){ const ds = doc.createdAt.toDate().toISOString().split('T')[0]; if(dailyData.hasOwnProperty(ds)) dailyData[ds]++; } });
            dailySharesChart.data.labels = labels;
            dailySharesChart.data.datasets = [{ label: 'æ¯æ—¥åˆ†äº«æ•¸', data: Object.values(dailyData), backgroundColor: 'rgba(79, 70, 229, 0.5)' }];
            dailySharesChart.update();
        }

        function updateHourlySharesChart(docs) {
            const hourlyData = Array(24).fill(0);
            docs.forEach(doc => { if (doc.createdAt?.toDate) { hourlyData[doc.createdAt.toDate().getUTCHours()]++; } });
            hourlySharesChart.data.labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            hourlySharesChart.data.datasets = [{ label: 'æ¯å°æ™‚åˆ†äº«æ•¸ (UTC)', data: hourlyData, backgroundColor: 'rgba(16, 185, 129, 0.5)' }];
            hourlySharesChart.update();
        }
    </script>
</body>
</html>
