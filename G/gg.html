<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP æ­¥é©Ÿ3 - å®Œæ•´å•Ÿå‹•æµç¨‹æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0c0a18; }
        .status-log li { transition: all 0.3s ease; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="text-center p-6 bg-gray-800 rounded-lg shadow-xl max-w-lg mx-auto w-full">
        <h1 class="text-xl font-bold text-white mb-4">MVP æ­¥é©Ÿ3ï¼šå®Œæ•´å•Ÿå‹•æµç¨‹æ¸¬è©¦</h1>
        <ol id="status-log" class="text-left space-y-2 text-gray-300 text-sm">
            <!-- æ¸¬è©¦æ—¥èªŒæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </ol>
    </div>

    <script type="module">
        // å¾ Firebase CDN åŒ¯å…¥æ‰€æœ‰éœ€è¦çš„åŠŸèƒ½
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, writeBatch, collection, onSnapshot, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const logList = document.getElementById('status-log');
        
        // ç”¨æ–¼åœ¨ç•«é¢ä¸Šé¡¯ç¤ºæ—¥èªŒçš„è¼”åŠ©å‡½å¼
        function logStatus(message, isSuccess = null) {
            const li = document.createElement('li');
            let statusIcon = 'â³';
            if (isSuccess === true) statusIcon = 'âœ…';
            if (isSuccess === false) statusIcon = 'âŒ';
            
            li.innerHTML = `${statusIcon} ${message}`;
            
            if (isSuccess === true) li.classList.add('text-green-400');
            if (isSuccess === false) li.classList.add('text-red-400', 'font-bold');
            
            logList.appendChild(li);
        }

        // --- é–‹å§‹æ•´åˆæ‰€æœ‰ JS æª”æ¡ˆçš„é‚è¼¯ ---

        // 1. ä¾†è‡ª app-config.js & game-config.js çš„æ ¸å¿ƒè¨­å®š
        logStatus("æ­£åœ¨è¼‰å…¥æ‡‰ç”¨ç¨‹å¼è¨­å®š...");
        const serviceKeys = {
            firebaseConfig: {
                apiKey: "AIzaSyDbWa8TWru1J048WK8msVBaC9JhhhtuhJw",
                authDomain: "goddess-chance.firebaseapp.com",
                projectId: "goddess-chance",
                storageBucket: "goddess-chance.firebasestorage.app",
                messagingSenderId: "440990936442",
                appId: "1:440990936442:web:37d864cd13112f14913ac3",
                measurementId: "G-3HCCT2PFXX"
            }
        };
        const dbCollectionNames = { users: 'users', dailyTasks: 'dailyTasks', statistics: 'statistics', userStats: 'userStats', favorites: 'favorites', status: 'status' };
        const gameSettings = { dailyLimits: { generateOne: 20, generateFour: 2, gacha: 5, tts: 3 } };
        const userStatsStructure = { likes: 0, shares: 0, gachaDraws: 0 };
        logStatus("æ‡‰ç”¨ç¨‹å¼è¨­å®šè¼‰å…¥å®Œæˆã€‚", true);

        // 2. ä¾†è‡ª stateManager.js çš„é‚è¼¯ (ç°¡åŒ–ç‰ˆ)
        let _state = {};
        function initState(initialState) { _state = initialState; }
        function setState(newState) { Object.assign(_state, newState); }
        
        // 3. ä¾†è‡ª state.js çš„é‚è¼¯
        initState({ favorites: null });
        logStatus("ç‹€æ…‹ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆã€‚", true);

        // 4. ä¾†è‡ª dailyTaskManager.js çš„æ ¸å¿ƒé‚è¼¯ (ç°¡åŒ–ç‰ˆ)
        class DailyTask {
            constructor(taskName, db, userId) { this.name = taskName; this.db = db; this.userId = userId; }
            async checkAndSync() {
                const today = new Date().toISOString().split('T')[0];
                const docRef = doc(this.db, dbCollectionNames.users, this.userId, dbCollectionNames.dailyTasks, this.name);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists() || docSnap.data().lastUpdate !== today) {
                    await setDoc(docRef, { count: gameSettings.dailyLimits[this.name] || 0, lastUpdate: today });
                }
                return true;
            }
        }
        async function initDailyTaskManager(db, uid) {
            const tasks = Object.keys(gameSettings.dailyLimits);
            await Promise.all(tasks.map(taskName => new DailyTask(taskName, db, uid).checkAndSync()));
        }
        
        // 5. ä¾†è‡ª analyticsManager.js çš„æ ¸å¿ƒé‚è¼¯ (ç°¡åŒ–ç‰ˆ)
        async function initAnalyticsManager(db, uid) {
            const statsRef = doc(db, dbCollectionNames.users, uid, dbCollectionNames.statistics, dbCollectionNames.userStats);
            const docSnap = await getDoc(statsRef);
            if (!docSnap.exists()) {
                await setDoc(statsRef, { ...userStatsStructure, firstLogin: serverTimestamp(), lastLogin: serverTimestamp() });
            } else {
                await setDoc(statsRef, { lastLogin: serverTimestamp() }, { merge: true });
            }
        }

        // 6. ä¾†è‡ª gfirebase.js çš„æ ¸å¿ƒé‚è¼¯
        function listenToFavorites(db, uid, callback) {
            const favoritesCol = collection(db, dbCollectionNames.users, uid, dbCollectionNames.favorites);
            return onSnapshot(favoritesCol, 
                (snapshot) => callback(snapshot.docs.map(doc => doc.data()), null),
                (error) => callback([], error)
            );
        }

        // --- ä¸»æ¸¬è©¦æµç¨‹ ---
        async function runFullTest() {
            let app, auth, db, user;

            try {
                logStatus("1. åˆå§‹åŒ– Firebase...");
                app = initializeApp(serviceKeys.firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                logStatus("Firebase åˆå§‹åŒ–æˆåŠŸã€‚", true);

                logStatus("2. æ­£åœ¨åŒ¿åç™»å…¥...");
                const userCredential = await signInAnonymously(auth);
                user = userCredential.user;
                logStatus(`åŒ¿åç™»å…¥æˆåŠŸ (ID: ...${user.uid.slice(-6)})`, true);

                logStatus("3. åˆå§‹åŒ–æ¯æ—¥ä»»å‹™ç®¡ç†å™¨...");
                await initDailyTaskManager(db, user.uid);
                logStatus("æ¯æ—¥ä»»å‹™ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸã€‚", true);

                logStatus("4. åˆå§‹åŒ–åˆ†æç®¡ç†å™¨...");
                await initAnalyticsManager(db, user.uid);
                logStatus("åˆ†æç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸã€‚", true);

                logStatus("5. å•Ÿå‹•ã€æˆ‘çš„æœ€æ„›ã€å³æ™‚ç›£è½...");
                listenToFavorites(db, user.uid, (favorites, error) => {
                    if (error) {
                        logStatus(`ç›£è½ã€æˆ‘çš„æœ€æ„›ã€å¤±æ•—: ${error.message}`, false);
                    } else {
                        logStatus(`æˆåŠŸæ¥æ”¶åˆ° ${favorites.length} ç­†ã€æˆ‘çš„æœ€æ„›ã€è³‡æ–™ã€‚`, true);
                        logStatus("ğŸ‰ æ‰€æœ‰å•Ÿå‹•æ­¥é©Ÿå·²æˆåŠŸå®Œæˆï¼", true);
                    }
                });

            } catch (error) {
                console.error("æ¸¬è©¦éç¨‹ä¸­ç™¼ç”Ÿè‡´å‘½éŒ¯èª¤:", error);
                logStatus(`æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        runFullTest();
    </script>

</body>
</html>
