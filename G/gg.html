<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP Ê≠•È©ü4 - ËºâÂÖ•ÂãïÁï´Ê∏¨Ë©¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-night: #0c0a18;
            --header-bg-night: rgba(12, 10, 24, 0.85);
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color-night); color: #F3F4F6; overflow-x: hidden; }
        .main-container { position: relative; z-index: 10; }
        .sticky-header { position: sticky; top: 0; z-index: 100; background-color: var(--header-bg-night); padding-top: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; padding-top: 1.5rem; }
        .image-card { background-color: rgba(31, 41, 55, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; overflow: hidden; position: relative; opacity: 0; animation: fadeIn 0.8s ease-out forwards; aspect-ratio: 2 / 3; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { width: 60px; height: 60px; border: 5px solid #4B5563; border-bottom-color: #EC4899; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 0.75rem; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; align-items: center; z-index: 5; }
        .like-btn { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: rgba(255, 255, 255, 0.7); }
        .like-btn.liked { color: #ef4444; }
        .tab-button { border-bottom: 3px solid transparent; }
        .tab-button.active { color: #EC4899; border-bottom-color: #EC4899; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #message-box { position: fixed; top: 20px; right: 20px; background-color: #EC4899; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 3100; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        #message-box.show { opacity: 1; transform: translateY(0); }
        
        /* ‚ú® Êñ∞Â¢ûÔºöËºâÂÖ•ÂãïÁï´ÁöÑ CSS */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(12,10,24,1) 35%, rgba(46,16,49,1) 100%); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1s ease-out; opacity: 1; }
        #loading-overlay.hidden { opacity: 0; pointer-events: none; }
        #loading-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #loading-content { z-index: 10; text-align: center; color: white; text-shadow: 0 0 15px rgba(236, 72, 153, 0.7); }
        .silhouette-container { height: 40vh; max-height: 400px; margin-bottom: 2rem; position: relative; width: 300px; display: flex; justify-content: center; align-items: center; }
        .loading-silhouette { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 15px rgba(236, 72, 153, 0.5)); opacity: 0; animation-timing-function: ease-in-out; animation-iteration-count: infinite; animation-fill-mode: both; }
        @keyframes silhouette-fade { 0%, 100% { opacity: 0; transform: scale(0.8); } 15% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <!-- ‚ú® Êñ∞Â¢ûÔºöÂÆåÊï¥ÁöÑËºâÂÖ•Áï´Èù¢ HTML -->
    <div id="loading-overlay">
        <canvas id="loading-canvas"></canvas>
        <div id="loading-content">
             <div class="silhouette-container"></div>
            <h2 id="loading-text" class="text-2xl font-bold text-gray-300 mt-4"></h2>
        </div>
    </div>

    <div class="main-container" style="opacity:0; transition: opacity 1s ease;">
        <header class="sticky-header">
            <div class="container mx-auto px-4">
                <h1 id="header-title" class="text-3xl md:text-4xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500 mb-2"></h1>
                <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 my-4">
                    <button id="generate-one-btn" class="text-white font-bold py-2 px-6 rounded-full text-lg bg-pink-500"></button>
                    <button id="generate-four-btn" class="text-white font-bold py-2 px-6 rounded-full text-lg bg-indigo-500"></button>
                    <button id="favorites-btn" class="text-white font-bold py-2 px-6 rounded-full text-lg bg-pink-500"><span id="favorites-btn-text">Â•≥Á•ûÊÆøÂ†Ç</span> ‚ù§Ô∏è <span id="favorites-count">0</span></button>
                </div>
                <nav id="tab-navigation" class="flex justify-center border-b border-gray-700"></nav>
                <div id="user-info" class="text-center text-xs text-gray-500 py-1"></div>
            </div>
        </header>
        <main id="style-sections" class="container mx-auto px-4"></main>
    </div>
    <div id="message-box"></div>

    <script type="module">
        // ÂåØÂÖ• Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // --- Êï¥ÂêàÊâÄÊúâ JS Ê™îÊ°àÁöÑÈÇèËºØ ---
        
        // --- Ë®≠ÂÆöÊ™î ---
        const appInfo = { title: "Â•≥Á•ûÊÖæË¶ãGoddeSpark" };
        const serviceKeys = { firebaseConfig: { apiKey: "AIzaSyDbWa8TWru1J048WK8msVBaC9JhhhtuhJw", authDomain: "goddess-chance.firebaseapp.com", projectId: "goddess-chance", storageBucket: "goddess-chance.appspot.com", messagingSenderId: "440990936442", appId: "1:440990936442:web:37d864cd13112f14913ac3" }};
        const uiMessages = { buttons: { generateOne: "ÈÅáË¶ã‰∏Ä‰Ωç", generateFour: "ÈÅáË¶ãÂõõ‰Ωç" }, errors: { cloudConnect: "ÁÑ°Ê≥ïÈÄ£Êé•Èõ≤Á´Ø", firebaseInit: "Firebase ÂàùÂßãÂåñÂ§±Êïó" }, loading: { connecting: "Ê≠£Âú®ÈÄ£Êé•Èõ≤Á´Ø...", starting: "ÈÇÇÈÄÖÂç≥Â∞áÈñãÂßã..." } };
        const styles = [{ id: "beach-silhouette", title: "üèñÔ∏è Â§èÊó•ÊàÄÊõ≤", prompt: "A sexy Asian model on a sunny beach" }];
        const uiSettings = {
            loadingScreenDuration: 3000,
            loadingSilhouettes: ['https://placehold.co/300x450/1f2937/9ca3af?text=Goddess+1', 'https://placehold.co/300x450/1f2937/9ca3af?text=Goddess+2', 'https://placehold.co/300x450/1f2937/9ca3af?text=Goddess+3'],
            loadingPetalCount: 60,
            loadingAnimationStep: 1,
        };

        // --- ÁãÄÊÖãÁÆ°ÁêÜÂô® ---
        let _state = {};
        const _subscribers = {};
        function initState(initialState) { _state = initialState; }
        function getState(key) { return _state[key]; }
        function setState(newState) { for (const key in newState) { if (_state[key] !== newState[key]) { _state[key] = newState[key]; if (_subscribers[key]) { _subscribers[key].forEach(cb => cb(_state[key])); } } } }
        function subscribe(key, callback) { if (!_subscribers[key]) { _subscribers[key] = []; } _subscribers[key].push(callback); if (key in _state) { callback(_state[key]); } }
        
        initState({ activeStyleId: styles[0].id, favorites: null });

        // --- UI & ÂãïÁï´ÈÇèËºØ ---
        const messageBox = document.getElementById('message-box');
        function showMessage(text) { messageBox.textContent = text; messageBox.classList.add('show'); setTimeout(() => messageBox.classList.remove('show'), 3000); }
        
        // ‚ú® Êñ∞Â¢ûÔºöËºâÂÖ•ÂãïÁï´ÁöÑ JS ÈÇèËºØ
        class Petal {
            constructor(c) { this.canvas = c; this.x = Math.random()*c.width; this.y = Math.random()*c.height*2-c.height; this.w = 20+Math.random()*15; this.h = 15+Math.random()*10; this.opacity = this.w/35; this.xSpeed = 1+Math.random(); this.ySpeed = .5+Math.random()*.5; this.flip = Math.random(); this.flipSpeed = Math.random()*.03; }
            draw() { const ctx = this.canvas.getContext('2d'); if(this.y > this.canvas.height || this.x > this.canvas.width){this.x=-this.w; this.y=Math.random()*this.canvas.height*2-this.canvas.height;} ctx.globalAlpha = this.opacity; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.bezierCurveTo(this.x+this.w/2, this.y-this.h/2, this.x+this.w, this.y, this.x+this.w/2, this.y+this.h/2); ctx.closePath(); const grad = ctx.createLinearGradient(this.x, this.y, this.x+this.w, this.y+this.h); grad.addColorStop(0, 'rgba(255,192,203,.8)'); grad.addColorStop(1, 'rgba(236,72,153,.5)'); ctx.fillStyle = grad; ctx.fill(); }
            animate() { this.x+=this.xSpeed; this.y+=this.ySpeed; this.flip+=this.flipSpeed; this.draw(); }
        }
        function resizeLoadingCanvas(c) { if (!c) return; c.width=window.innerWidth; c.height=window.innerHeight; }
        function animateLoading(c, p, o) { if (!c || !o || o.classList.contains('hidden')) return; const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); p.forEach(petal => petal.animate()); requestAnimationFrame(() => animateLoading(c, p, o)); }

        // --- Firebase ÈÇèËºØ ---
        let db, auth, currentUserId;
        function initFirebase() { try { const app = initializeApp(serviceKeys.firebaseConfig); auth = getAuth(app); db = getFirestore(app); return true; } catch (e) { return false; } }
        function handleAuthentication(cb) { onAuthStateChanged(auth, (u) => { if (u) { currentUserId = u.uid; cb(u.uid); } else { signInAnonymously(auth).catch((err) => cb(null, err)); } }); }
        async function getUserData(uid) { const snap = await getDoc(doc(db, 'users', uid)); return snap.exists() ? snap.data() : { nickname: 'ÁÑ°ÂêçÊ∞è' }; }
        function listenToFavorites(cb) { onSnapshot(collection(db, 'users', currentUserId, 'favorites'), (s) => cb(s.docs.map(d => d.data()))); }

        // --- UI ÁÆ°ÁêÜ ---
        let DOMElements = {};
        function initializeUI() {
            DOMElements = {
                headerTitle: document.getElementById('header-title'),
                tabNavigation: document.getElementById('tab-navigation'),
                styleSectionsContainer: document.getElementById('style-sections'),
                generateOneBtn: document.getElementById('generate-one-btn'),
                generateFourBtn: document.getElementById('generate-four-btn'),
                favoritesCount: document.getElementById('favorites-count'),
                userInfo: document.getElementById('user-info'),
            };
            DOMElements.headerTitle.textContent = appInfo.title;
            DOMElements.generateOneBtn.textContent = uiMessages.buttons.generateOne;
            DOMElements.generateFourBtn.textContent = uiMessages.buttons.generateFour;
            styles.forEach((style, index) => {
                const tab = document.createElement('button');
                tab.className = `tab-button text-gray-400 py-2 px-4 ${index === 0 ? 'active' : ''}`;
                tab.textContent = style.title;
                tab.onclick = () => setState({ activeStyleId: style.id });
                DOMElements.tabNavigation.appendChild(tab);
                const section = document.createElement('section');
                section.id = `content-${style.id}`;
                section.className = `tab-content ${index === 0 ? 'active' : ''}`;
                section.innerHTML = `<div id="${style.id}-gallery" class="card-container"></div>`;
                DOMElements.styleSectionsContainer.appendChild(section);
            });
        }
        function updateUserInfo(uid, nickname) { DOMElements.userInfo.textContent = `ID: ${uid ? `...${uid.slice(-6)}` : 'N/A'} (${nickname})`; }

        // --- ‰∏ªÁ®ãÂºè ---
        let isLoadingOverlayHidden = false;
        function hideLoadingOverlay() {
            if (isLoadingOverlayHidden) return;
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('hidden');
            isLoadingOverlayHidden = true;
        }

        function startLoadingSequence() {
            const overlay = document.getElementById('loading-overlay');
            const textEl = document.getElementById('loading-text');
            const silhouetteEl = document.querySelector('.silhouette-container');
            const canvasEl = document.getElementById('loading-canvas');
            if(textEl) textEl.textContent = uiMessages.loading.connecting;

            silhouetteEl.innerHTML = uiSettings.loadingSilhouettes.map(src => `<img src="${src}" class="loading-silhouette">`).join('');
            document.querySelectorAll('.loading-silhouette').forEach((el, i) => {
                el.style.animationDelay = `${i * uiSettings.loadingAnimationStep}s`;
                el.style.animationDuration = `${uiSettings.loadingSilhouettes.length * uiSettings.loadingAnimationStep}s`;
                el.style.animationName = 'silhouette-fade';
            });

            resizeLoadingCanvas(canvasEl);
            let petals = Array.from({ length: uiSettings.loadingPetalCount }, () => new Petal(canvasEl));
            animateLoading(canvasEl, petals, overlay);

            setTimeout(() => {
                if(textEl) textEl.textContent = uiMessages.loading.starting;
                setTimeout(() => {
                    hideLoadingOverlay();
                    document.querySelector('.main-container').style.opacity = '1';
                }, 500);
            }, uiSettings.loadingScreenDuration);
        }

        window.onload = () => {
            initState(getInitialState());
            initializeUI();
            
            subscribe('activeStyleId', (id) => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.toggle('active', b.textContent === styles.find(s => s.id === id).title));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `content-${id}`));
            });
            subscribe('favorites', (favs) => { if(favs) DOMElements.favoritesCount.textContent = favs.length; });

            if (initFirebase()) {
                handleAuthentication(onUserSignedIn);
            } else {
                showMessage(uiMessages.errors.firebaseInit);
            }
        };

        async function onUserSignedIn(uid) {
            if (uid) {
                // ‚ú® ÊîπËÆäÔºö‰∏çÂú®ÁôªÂÖ•ÂæåÈö±ËóèÔºåËÆì startLoadingSequence ÊéßÂà∂
                startLoadingSequence(); 
                const userData = await getUserData(uid);
                updateUserInfo(uid, userData.nickname);
                listenToFavorites((favs) => setState({ favorites: favs }));
            } else {
                showMessage(uiMessages.errors.cloudConnect);
            }
        }
    </script>
</body>
</html>
