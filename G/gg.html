<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP ç©©å›ºåŸºç¤ - å¾Œç«¯åˆå§‹åŒ–æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0c0a18; }
        .status-log li { transition: all 0.3s ease; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="text-center p-6 bg-gray-800 rounded-lg shadow-xl max-w-lg mx-auto w-full">
        <h1 class="text-xl font-bold text-white mb-4">MVP ç©©å›ºåŸºç¤æ¸¬è©¦</h1>
        <ol id="status-log" class="text-left space-y-2 text-gray-300 text-sm">
            <!-- æ¸¬è©¦æ—¥èªŒæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </ol>
    </div>

    <script type="module">
        // --- Firebase CDN Imports ---
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, writeBatch, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const logList = document.getElementById('status-log');
        
        // --- è¼”åŠ©å‡½å¼ ---
        function logStatus(message, isSuccess = null) {
            const li = document.createElement('li');
            let statusIcon = 'â³';
            if (isSuccess === true) statusIcon = 'âœ…';
            if (isSuccess === false) statusIcon = 'âŒ';
            
            li.innerHTML = `${statusIcon} ${message}`;
            
            if (isSuccess === true) li.classList.add('text-green-400');
            if (isSuccess === false) li.classList.add('text-red-400', 'font-bold');
            
            logList.appendChild(li);
        }

        // --- æ•´åˆæ‰€æœ‰ JS æª”æ¡ˆçš„é‚è¼¯ (å·²é©—è­‰éƒ¨åˆ†) ---

        // --- è¨­å®šæª” (app-config.js & game-config.js) ---
        const serviceKeys = { firebaseConfig: { apiKey: "AIzaSyDbWa8TWru1J048WK8msVBaC9JhhhtuhJw", authDomain: "goddess-chance.firebaseapp.com", projectId: "goddess-chance", storageBucket: "goddess-chance.appspot.com", messagingSenderId: "440990936442", appId: "1:440990936442:web:37d864cd13112f14913ac3" }};
        const dbCollectionNames = { users: 'users', dailyTasks: 'dailyTasks', statistics: 'statistics', userStats: 'userStats', favorites: 'favorites' };
        const gameSettings = { dailyLimits: { generateOne: 20, generateFour: 2, gacha: 20, tts: 3 } };
        const userStatsStructure = { likes: 0, unlikes: 0, shares: 0 };
        const randomNicknames = ["Dæ§½å¥³ç¥å®˜", "æ³¢å¤šé‡çµå†°"];

        // --- DailyTaskManager (å·²ä¿®æ­£èªæ³•) ---
        class DailyTask {
            constructor(taskName, db, userId) { this.name = taskName; this.db = db; this.userId = userId; this.defaultCount = gameSettings.dailyLimits[taskName]; this.state = { count: this.defaultCount, lastUpdate: null, }; this.docRef = doc(this.db, dbCollectionNames.users, userId, dbCollectionNames.dailyTasks, this.name); this.isInitialized = false; }
            async _checkAndSync() { if (this.isInitialized && this.state.lastUpdate === new Date().toISOString().split('T')[0]) { return; } const today = new Date().toISOString().split('T')[0]; const docSnap = await getDoc(this.docRef); if (docSnap.exists()) { const dbState = docSnap.data(); if (dbState.lastUpdate === today) { this.state = dbState; } else { this.state.count = Math.max(dbState.count, this.defaultCount); this.state.lastUpdate = today; await this._save(); } } else { this.state.count = this.defaultCount; this.state.lastUpdate = today; await this._save(); } this.isInitialized = true; }
            async _save() { await setDoc(this.docRef, this.state); }
            async getCount() { await this._checkAndSync(); return this.state.count; }
        }
        const tasks = {};
        async function initDailyTaskManager(db, uid) { for (const taskName in gameSettings.dailyLimits) { tasks[taskName] = new DailyTask(taskName, db, uid); await tasks[taskName].getCount(); } }
        
        // --- AnalyticsManager ---
        let statsRef;
        async function initAnalyticsManager(db, uid) { statsRef = doc(db, 'users', uid, 'statistics', 'userStats'); const docSnap = await getDoc(statsRef); if (!docSnap.exists()) { const nickname = randomNicknames[Math.floor(Math.random() * randomNicknames.length)]; const userDocRef = doc(db, 'users', uid); await Promise.all([ setDoc(statsRef, { ...userStatsStructure, firstLogin: serverTimestamp(), lastLogin: serverTimestamp() }), setDoc(userDocRef, { nickname: nickname }) ]); } else { await setDoc(statsRef, { lastLogin: serverTimestamp() }, { merge: true }); } }

        // --- gfirebase (æ ¸å¿ƒéƒ¨åˆ†) ---
        let currentUserId;
        function getCurrentUserId() { return currentUserId; }
        async function getUserData(db, uid) { if (!uid) return null; const userRef = doc(db, dbCollectionNames.users, uid); const docSnap = await getDoc(userRef); return docSnap.exists() ? docSnap.data() : { nickname: 'ç„¡åæ°' }; }
        function listenToFavorites(db, uid, callback) { const favoritesCol = collection(db, dbCollectionNames.users, uid, dbCollectionNames.favorites); return onSnapshot(favoritesCol, (snapshot) => callback(snapshot.docs.map(d => d.data()), null), (error) => callback([], error)); }

        // --- ä¸»æ¸¬è©¦æµç¨‹ ---
        async function runFullTest() {
            let app, auth, db, user;
            try {
                logStatus("1. åˆå§‹åŒ– Firebase...");
                app = initializeApp(serviceKeys.firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                logStatus("Firebase åˆå§‹åŒ–æˆåŠŸã€‚", true);

                logStatus("2. æ­£åœ¨åŒ¿åç™»å…¥...");
                const userCredential = await signInAnonymously(auth);
                user = userCredential.user;
                currentUserId = user.uid;
                logStatus(`åŒ¿åç™»å…¥æˆåŠŸ (ID: ...${user.uid.slice(-6)})`, true);

                logStatus("3. åˆå§‹åŒ–æ¯æ—¥ä»»å‹™ç®¡ç†å™¨...");
                await initDailyTaskManager(db, user.uid);
                logStatus("æ¯æ—¥ä»»å‹™ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸã€‚", true);

                logStatus("4. åˆå§‹åŒ–åˆ†æç®¡ç†å™¨...");
                await initAnalyticsManager(db, user.uid);
                logStatus("åˆ†æç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸã€‚", true);

                logStatus("5. å•Ÿå‹•ã€æˆ‘çš„æœ€æ„›ã€å³æ™‚ç›£è½...");
                const unsubscribe = listenToFavorites(db, user.uid, (favorites, error) => {
                    if (error) {
                        logStatus(`ç›£è½ã€æˆ‘çš„æœ€æ„›ã€å¤±æ•—: ${error.message}`, false);
                    } else {
                        logStatus(`æˆåŠŸæ¥æ”¶åˆ° ${favorites.length} ç­†ã€æˆ‘çš„æœ€æ„›ã€è³‡æ–™ã€‚`, true);
                        logStatus("ğŸ‰ æ‰€æœ‰å¾Œç«¯æœå‹™åˆå§‹åŒ–æˆåŠŸï¼", true);
                        unsubscribe(); // æ”¶åˆ°ä¸€æ¬¡å›é¥‹å¾Œå°±åœæ­¢ç›£è½
                    }
                });

            } catch (error) {
                console.error("æ¸¬è©¦éç¨‹ä¸­ç™¼ç”Ÿè‡´å‘½éŒ¯èª¤:", error);
                logStatus(`æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        runFullTest();
    </script>

</body>
</html>
