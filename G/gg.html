<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP æ­¥é©Ÿ4 - UI æ¡†æ¶æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0c0a18; color: #F3F4F6; }
        .main-container { opacity: 0; transition: opacity 1s ease-in-out; }
        .sticky-header { position: sticky; top: 0; z-index: 100; background-color: rgba(12, 10, 24, 0.85); padding-top: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tab-button { border-bottom: 3px solid transparent; }
        .tab-button.active { color: #EC4899; border-bottom-color: #EC4899; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn-base { transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(45deg, #EC4899, #8B5CF6); }
        .btn-secondary { background: linear-gradient(45deg, #4f46e5, #8b5cf6); }
    </style>
</head>
<body class="p-4">

    <!-- æ¸¬è©¦æ—¥èªŒ -->
    <div id="test-log-container" class="fixed top-0 left-0 w-full bg-black bg-opacity-80 text-white p-2 z-50 text-xs font-mono">
        <h2 class="font-bold">[åµéŒ¯æ—¥èªŒ]</h2>
        <ol id="status-log" class="space-y-1"></ol>
    </div>

    <!-- å®Œæ•´çš„ App HTML çµæ§‹ -->
    <div class="main-container">
        <header class="sticky-header">
            <div class="container mx-auto px-4">
                <h1 id="header-title" class="text-3xl md:text-4xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500 mb-2"></h1>
                <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 my-4">
                    <button id="generate-one-btn" class="btn-base btn-primary text-white font-bold py-2 px-6 rounded-full text-lg"></button>
                    <button id="generate-four-btn" class="btn-base btn-secondary text-white font-bold py-2 px-6 rounded-full text-lg"></button>
                    <button id="favorites-btn" class="btn-base btn-primary text-white font-bold py-2 px-6 rounded-full text-lg"><span id="favorites-btn-text"></span> â¤ï¸ <span id="favorites-count">0</span></button>
                </div>
                <nav id="tab-navigation" class="flex justify-center border-b border-gray-700"></nav>
                <div id="user-info" class="text-center text-xs text-gray-500 py-1"></div>
            </div>
        </header>
        <main id="style-sections" class="container mx-auto px-4"></main>
    </div>

    <script type="module">
        // --- Firebase CDN Imports ---
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const logList = document.getElementById('status-log');
        function logStatus(message, isSuccess = null) {
            const li = document.createElement('li');
            let statusIcon = 'â³';
            if (isSuccess === true) statusIcon = 'âœ…';
            if (isSuccess === false) statusIcon = 'âŒ';
            li.innerHTML = `${statusIcon} ${message}`;
            if (isSuccess === true) li.classList.add('text-green-400');
            if (isSuccess === false) li.classList.add('text-red-400', 'font-bold');
            logList.appendChild(li);
        }

        // --- æ•´åˆæ‰€æœ‰ JS æª”æ¡ˆçš„é‚è¼¯ ---

        // --- è¨­å®šæª” ---
        const appInfo = { title: "å¥³ç¥æ…¾è¦‹GoddeSpark", version: "1.6.62" };
        const serviceKeys = { firebaseConfig: { apiKey: "AIzaSyDbWa8TWru1J048WK8msVBaC9JhhhtuhJw", authDomain: "goddess-chance.firebaseapp.com", projectId: "goddess-chance", storageBucket: "goddess-chance.appspot.com", messagingSenderId: "440990936442", appId: "1:440990936442:web:37d864cd13112f14913ac3" }};
        const styles = [{ id: "beach-silhouette", title: "ğŸ–ï¸ å¤æ—¥æˆ€æ›²", description: "æµ·ç˜ã€æ€§æ„Ÿï¼ŒèåŒ–ä½ å¿ƒçš„å¤æ—¥æµ·ç˜æˆ€æ›²" }, { id: "morning-lazy", title: "â˜€ï¸ æ™¨å…‰ç§æˆ¿", description: "æ…µæ‡¶ã€ç§å¯†ã€å±¬æ–¼ä½ çš„å¥³å‹æ„Ÿç¬é–“" }];
        const uiMessages = { buttons: { generateOne: "é‡è¦‹ä¸€ä½", generateFour: "é‡è¦‹å››ä½", favorites: "å¥³ç¥æ®¿å ‚" } };

        // --- ç‹€æ…‹ç®¡ç†å™¨ ---
        let _state = {};
        const _subscribers = {};
        function initState(initialState) { _state = initialState; }
        function setState(newState) { for (const key in newState) { if (Object.prototype.hasOwnProperty.call(newState, key)) { if (_state[key] !== newState[key]) { _state[key] = newState[key]; if (_subscribers[key]) { _subscribers[key].forEach(callback => callback(_state[key])); } } } } }
        function subscribe(key, callback) { if (!_subscribers[key]) { _subscribers[key] = []; } _subscribers[key].push(callback); if (key in _state) { callback(_state[key]); } }
        function getInitialState() { return { activeStyleId: styles[0].id, favorites: null, userNickname: '' }; }

        // --- UI ç®¡ç†å™¨ (æ ¸å¿ƒæ¸¬è©¦éƒ¨åˆ†) ---
        let DOMElements = {};
        function initializeUI() {
            logStatus("UI Manager: æ­£åœ¨æŠ“å– DOM å…ƒç´ ...");
            DOMElements = {
                headerTitle: document.getElementById('header-title'),
                tabNavigation: document.getElementById('tab-navigation'),
                styleSectionsContainer: document.getElementById('style-sections'),
                generateOneBtn: document.getElementById('generate-one-btn'),
                generateFourBtn: document.getElementById('generate-four-btn'),
                favoritesBtn: document.getElementById('favorites-btn'),
                favoritesBtnText: document.getElementById('favorites-btn-text'),
                favoritesCount: document.getElementById('favorites-count'),
                userInfo: document.getElementById('user-info'),
            };
            logStatus("UI Manager: DOM å…ƒç´ æŠ“å–å®Œç•¢ã€‚", true);

            logStatus("UI Manager: æ­£åœ¨è¨­å®š UI æ–‡å­—...");
            DOMElements.headerTitle.innerHTML = `${appInfo.title} <span class="text-base align-middle text-gray-400 font-medium">v${appInfo.version}</span>`;
            DOMElements.generateOneBtn.textContent = uiMessages.buttons.generateOne;
            DOMElements.generateFourBtn.textContent = uiMessages.buttons.generateFour;
            DOMElements.favoritesBtnText.textContent = uiMessages.buttons.favorites;
            logStatus("UI Manager: UI æ–‡å­—è¨­å®šå®Œç•¢ã€‚", true);

            logStatus("UI Manager: æ­£åœ¨å»ºç«‹åˆ†é èˆ‡å€å¡Š...");
            styles.forEach((style, index) => {
                const tabButton = document.createElement('button');
                tabButton.className = `tab-button text-md font-medium py-2 px-4 text-gray-400 ${index === 0 ? 'active' : ''}`;
                tabButton.textContent = style.title;
                tabButton.dataset.styleId = style.id;
                DOMElements.tabNavigation.appendChild(tabButton);

                const section = document.createElement('section');
                section.id = `content-${style.id}`;
                section.className = `tab-content ${index === 0 ? 'active' : ''}`;
                section.innerHTML = `<div class="text-center mb-8 mt-4"><p class="text-gray-400 mt-1">${style.description}</p></div><div id="${style.id}-gallery" class="card-container mb-8"></div>`;
                DOMElements.styleSectionsContainer.appendChild(section);
            });
            logStatus("UI Manager: åˆ†é èˆ‡å€å¡Šå»ºç«‹å®Œç•¢ã€‚", true);

            logStatus("UI Manager: æ­£åœ¨ç¶å®šäº‹ä»¶ç›£è½...");
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    logStatus(`Event: Clicked tab ${button.dataset.styleId}`);
                    setState({ activeStyleId: button.dataset.styleId });
                });
            });
            logStatus("UI Manager: äº‹ä»¶ç›£è½ç¶å®šå®Œç•¢ã€‚", true);
        }
        function updateUserInfo(uid, nickname) {
            if (DOMElements.userInfo) {
                const uidText = uid ? `...${uid.slice(-6)}` : 'å°šæœªç™»å…¥';
                DOMElements.userInfo.innerHTML = `é›²ç«¯ä½¿ç”¨è€… (${nickname}) ID: ${uidText}`;
            }
        }
        function setupSubscriptions() {
             logStatus("æ­£åœ¨è¨­å®šç‹€æ…‹è¨‚é–±...");
            subscribe('activeStyleId', (styleId) => {
                logStatus(`State Change: activeStyleId is now ${styleId}`);
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.styleId === styleId));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `content-${styleId}`));
            });
            subscribe('favorites', (favorites) => {
                if (favorites !== null) {
                    logStatus(`State Change: Favorites updated with ${favorites.length} items.`);
                    DOMElements.favoritesCount.textContent = favorites.length;
                }
            });
             logStatus("ç‹€æ…‹è¨‚é–±è¨­å®šå®Œç•¢ã€‚", true);
        }


        // --- ä¸»æ¸¬è©¦æµç¨‹ ---
        async function runFullTest() {
            let app, auth, db, user;
            try {
                logStatus("1. åˆå§‹åŒ– Firebase...");
                app = initializeApp(serviceKeys.firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                logStatus("Firebase åˆå§‹åŒ–æˆåŠŸã€‚", true);

                logStatus("2. æ­£åœ¨åŒ¿åç™»å…¥...");
                const userCredential = await signInAnonymously(auth);
                user = userCredential.user;
                logStatus(`åŒ¿åç™»å…¥æˆåŠŸ (ID: ...${user.uid.slice(-6)})`, true);
                
                logStatus("3. æ­£åœ¨åˆå§‹åŒ– App ç‹€æ…‹...");
                initState(getInitialState());
                logStatus("App ç‹€æ…‹åˆå§‹åŒ–å®Œç•¢ã€‚", true);

                logStatus("4. æ­£åœ¨åˆå§‹åŒ– UI ä»‹é¢...");
                initializeUI();
                setupSubscriptions();
                logStatus("UI ä»‹é¢åˆå§‹åŒ–å®Œç•¢ã€‚", true);
                
                logStatus("5. æ­£åœ¨å–å¾—ä½¿ç”¨è€…è³‡æ–™...");
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                const userData = userDocSnap.exists() ? userDocSnap.data() : { nickname: 'ç„¡åæ°' };
                updateUserInfo(user.uid, userData.nickname);
                logStatus(`ä½¿ç”¨è€…è³‡æ–™å–å¾—å®Œç•¢ (Nickname: ${userData.nickname})`, true);

                logStatus("6. å•Ÿå‹•ã€æˆ‘çš„æœ€æ„›ã€å³æ™‚ç›£è½...");
                const favoritesCol = collection(db, 'users', user.uid, 'favorites');
                onSnapshot(favoritesCol, (snapshot) => {
                    const favs = snapshot.docs.map(d => d.data());
                    setState({ favorites: favs });
                });
                
                logStatus("ğŸ‰ App æ ¸å¿ƒå•Ÿå‹•æˆåŠŸï¼é¡¯ç¤ºä¸»ç•«é¢...", true);
                document.querySelector('.main-container').style.opacity = '1';

            } catch (error) {
                console.error("æ¸¬è©¦éç¨‹ä¸­ç™¼ç”Ÿè‡´å‘½éŒ¯èª¤:", error);
                logStatus(`æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        runFullTest();
    </script>

</body>
</html>
