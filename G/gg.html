<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊúÄÁµÇÊï¥ÂêàÊ∏¨Ë©¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Êï¥Âêà gstyle.css ÁöÑÂÖßÂÆπ (Â∑≤ÁßªÈô§ backdrop-filter) */
        :root {
            --bg-color-night: #0c0a18;
            --header-bg-night: rgba(12, 10, 24, 0.85);
            --bg-color-day: #fde6e6;
            --header-bg-day: rgba(255, 240, 240, 0.85);
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color-night); color: #F3F4F6; overflow-x: hidden; }
        body.theme-day { background-color: var(--bg-color-day); color: #4B5563; }
        #background-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0c0a18; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 1s ease-out; }
        #loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .main-container { position: relative; z-index: 10; }
        .sticky-header { position: sticky; top: 0; z-index: 100; background-color: var(--header-bg-night); padding-top: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        body.theme-day .sticky-header { background-color: var(--header-bg-day); border-bottom-color: rgba(0,0,0,0.1); }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; padding-top: 1.5rem; }
        .image-card { background-color: rgba(31, 41, 55, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; overflow: hidden; position: relative; perspective: 1000px; opacity: 0; animation: fadeIn 0.8s ease-out forwards; aspect-ratio: 2 / 3; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { width: 60px; height: 60px; border: 5px solid #4B5563; border-bottom-color: #EC4899; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.8); transition: transform 0.3s ease; max-width: 90vw; max-height: 90vh; }
        .modal.show .modal-content { transform: scale(1); }
        .card-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 0.75rem; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; align-items: center; z-index: 5; }
        .like-btn { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: rgba(255, 255, 255, 0.7); transition: transform 0.2s ease, color 0.2s ease; }
        .like-btn.liked { color: #ef4444; }
        .tab-button { transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab-button.active { color: #EC4899; border-bottom-color: #EC4899; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #message-box { position: fixed; top: 20px; right: 20px; background-color: #EC4899; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 3100; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        #message-box.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <!-- ÂÆåÊï¥ÁöÑ HTML ÁµêÊßã -->
    <div id="loading-overlay"><div class="loader"></div></div>
    <div id="image-modal" class="modal"><div id="image-modal-content" class="modal-content"><img id="modal-image" src="" alt="ÊîæÂ§ßÈ†êË¶Ω"></div></div>
    <div class="main-container" style="opacity:0; transition: opacity 1s ease;">
        <header class="sticky-header">
            <div class="container mx-auto px-4">
                <h1 id="header-title" class="text-3xl md:text-4xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500 mb-2"></h1>
                <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 my-4">
                    <button id="generate-one-btn" class="text-white font-bold py-2 px-6 rounded-full text-lg bg-pink-500"></button>
                    <button id="generate-four-btn" class="text-white font-bold py-2 px-6 rounded-full text-lg bg-indigo-500"></button>
                    <button id="favorites-btn" class="text-white font-bold py-2 px-6 rounded-full text-lg bg-pink-500"><span id="favorites-btn-text"></span> ‚ù§Ô∏è <span id="favorites-count">0</span></button>
                </div>
                <nav id="tab-navigation" class="flex justify-center border-b border-gray-700"></nav>
                <div id="user-info" class="text-center text-xs text-gray-500 py-1"></div>
            </div>
        </header>
        <main id="style-sections" class="container mx-auto px-4"></main>
    </div>
    <div id="message-box"></div>

    <script type="module">
        // Âæû Firebase CDN ÂåØÂÖ•ÊâÄÊúâÈúÄË¶ÅÁöÑÂäüËÉΩ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDoc, getDocs, query, limit, runTransaction, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // --- Êï¥ÂêàÊâÄÊúâ JS Ê™îÊ°àÁöÑÈÇèËºØ ---
        // ÁÇ∫‰∫ÜÁ∞°ÂåñÔºåÊàëÂÄëÂ∞áÊâÄÊúâ export const/function ËÆäÁÇ∫ÊôÆÈÄöÁöÑ const/function
        
        // --- app-config.js ---
        const appInfo = { title: "Â•≥Á•ûÊÖæË¶ãGoddeSpark", version: "1.6.62" };
        const serviceKeys = { firebaseConfig: { apiKey: "AIzaSyDbWa8TWru1J048WK8msVBaC9JhhhtuhJw", authDomain: "goddess-chance.firebaseapp.com", projectId: "goddess-chance", storageBucket: "goddess-chance.appspot.com", messagingSenderId: "440990936442", appId: "1:440990936442:web:37d864cd13112f14913ac3", measurementId: "G-3HCCT2PFXX" }, defaultApiKey: "AIzaSyAZUc69ryBPqw0Ss2ZV-f4Jg5kP3VjDd0c" };
        const dbCollectionNames = { users: 'users', publicGoddesses: 'public-goddesses', dailyTasks: 'dailyTasks', statistics: 'statistics', userStats: 'userStats', favorites: 'favorites' };

        // --- game-config.js ---
        const gameSettings = { dailyLimits: { generateOne: 20, generateFour: 2, gacha: 20, tts: 3 } };
        const uiMessages = { buttons: { generateOne: "ÈÅáË¶ã‰∏Ä‰Ωç", generateFour: "ÈÅáË¶ãÂõõ‰Ωç", favorites: "Â•≥Á•ûÊÆøÂ†Ç" }, errors: { cloudConnect: "ÁÑ°Ê≥ïÈÄ£Êé•Èõ≤Á´Ø", firebaseInit: "Firebase ÂàùÂßãÂåñÂ§±Êïó" } };
        const styles = [{ id: "beach-silhouette", title: "üèñÔ∏è Â§èÊó•ÊàÄÊõ≤", description: "Êµ∑ÁÅò„ÄÅÊÄßÊÑüÔºåËûçÂåñ‰Ω†ÂøÉÁöÑÂ§èÊó•Êµ∑ÁÅòÊàÄÊõ≤", prompt: "A sexy Asian model on a sunny beach, wearing a bikini, interacting warmly with the camera." }];
        const userStatsStructure = { likes: 0, shares: 0, gachaDraws: 0, totalGenerations: 0 };

        // --- stateManager.js ---
        let _state = {};
        const _subscribers = {};
        function initState(initialState) { _state = initialState; }
        function getState(...keys) { if (keys.length === 1) { return _state[keys[0]]; } const o = {}; for (const k of keys) { o[k] = _state[k]; } return o; }
        function setState(newState) { for (const key in newState) { if (_state[key] !== newState[key]) { _state[key] = newState[key]; if (_subscribers[key]) { _subscribers[key].forEach(cb => cb(_state[key])); } } } }
        function subscribe(key, callback) { if (!_subscribers[key]) { _subscribers[key] = []; } _subscribers[key].push(callback); if (key in _state) { callback(_state[key]); } return () => { _subscribers[key] = _subscribers[key].filter(cb => cb !== callback); }; }
        
        // --- state.js ---
        function getInitialState() { return { isGenerating: false, activeStyleId: styles[0].id, favorites: null }; }

        // --- gui.js ---
        const messageBox = document.getElementById('message-box');
        function showMessage(text, isError = false) { messageBox.textContent = text; messageBox.style.backgroundColor = isError ? '#E11D48' : '#EC4899'; messageBox.classList.add('show'); setTimeout(() => messageBox.classList.remove('show'), 3000); }
        function createImageCard(imageData, handlers) {
            const card = document.createElement('div');
            card.className = 'image-card';
            card.style.opacity = '1';
            card.innerHTML = `<div class="image-card-img-wrapper" style="width:100%; height:100%;"><img src="${imageData.src}" style="width:100%; height:100%; object-fit:cover;" alt="${imageData.style.title}"></div><div class="card-footer"><button class="like-btn ${imageData.isLiked ? 'liked' : ''}">‚ô•</button></div>`;
            card.querySelector('.like-btn').onclick = (e) => { e.stopPropagation(); handlers.onLike(imageData, e.target); };
            return card;
        }

        // --- dailyTaskManager.js & analyticsManager.js (Simplified for test) ---
        async function initDailyTaskManager(db, uid) { console.log("DailyTaskManager OK"); return true; }
        async function initAnalyticsManager(db, uid) { console.log("AnalyticsManager OK"); return true; }
        async function incrementStat(fields) { console.log("Incrementing stat:", fields); }

        // --- gfirebase.js ---
        let db, auth, storage, currentUserId;
        function initFirebase() { try { const app = initializeApp(serviceKeys.firebaseConfig); auth = getAuth(app); db = getFirestore(app); storage = getStorage(app); return true; } catch (e) { console.error(e); return false; } }
        function handleAuthentication(callback) { onAuthStateChanged(auth, (user) => { if (user) { currentUserId = user.uid; callback(user.uid); } else { signInAnonymously(auth).catch((err) => callback(null, err)); } }); }
        function getCurrentUserId() { return currentUserId; }
        async function getUserData(db, uid) { const snap = await getDoc(doc(db, 'users', uid)); return snap.exists() ? snap.data() : { nickname: 'ÁÑ°ÂêçÊ∞è' }; }
        function listenToFavorites(callback) { const q = collection(db, dbCollectionNames.users, currentUserId, dbCollectionNames.favorites); return onSnapshot(q, (snap) => callback(snap.docs.map(d => d.data()))); }
        async function saveFavorite(favData) { await setDoc(doc(db, dbCollectionNames.users, currentUserId, dbCollectionNames.favorites, favData.id), favData); }
        async function removeFavorite(favData) { await deleteDoc(doc(db, dbCollectionNames.users, currentUserId, dbCollectionNames.favorites, favData.id)); }

        // --- handlers.js (Simplified) ---
        function getCardHandlers() { return { onLike: toggleFavorite }; }
        async function toggleFavorite(imageData, btn) {
            const favorites = getState('favorites');
            if (favorites === null) return;
            const isLiked = favorites.some(fav => fav.id === imageData.id);
            if (isLiked) {
                await removeFavorite(imageData);
            } else {
                await saveFavorite({ id: imageData.id, style: imageData.style, imageUrl: imageData.src });
            }
        }
        async function handleImageGeneration() { alert("ÂúñÁâáÁîüÊàêÂäüËÉΩÂ∑≤Âú®Ê∏¨Ë©¶‰∏≠ÂÅúÁî®„ÄÇ"); }

        // --- uiManager.js ---
        let DOMElements = {};
        function initializeUI() {
            DOMElements = {
                headerTitle: document.getElementById('header-title'),
                tabNavigation: document.getElementById('tab-navigation'),
                styleSectionsContainer: document.getElementById('style-sections'),
                generateOneBtn: document.getElementById('generate-one-btn'),
                generateFourBtn: document.getElementById('generate-four-btn'),
                favoritesBtn: document.getElementById('favorites-btn'),
                favoritesCount: document.getElementById('favorites-count'),
                userInfo: document.getElementById('user-info'),
            };
            DOMElements.headerTitle.textContent = appInfo.title;
            DOMElements.generateOneBtn.textContent = uiMessages.buttons.generateOne;
            DOMElements.generateFourBtn.textContent = uiMessages.buttons.generateFour;
            DOMElements.favoritesBtn.querySelector('#favorites-btn-text').textContent = uiMessages.buttons.favorites;

            styles.forEach((style, index) => {
                const tab = document.createElement('button');
                tab.className = `tab-button py-2 px-4 ${index === 0 ? 'active' : ''}`;
                tab.textContent = style.title;
                tab.onclick = () => setState({ activeStyleId: style.id });
                DOMElements.tabNavigation.appendChild(tab);
                const section = document.createElement('section');
                section.id = `content-${style.id}`;
                section.className = `tab-content ${index === 0 ? 'active' : ''}`;
                section.innerHTML = `<div id="${style.id}-gallery" class="card-container"></div>`;
                DOMElements.styleSectionsContainer.appendChild(section);
            });
            DOMElements.generateOneBtn.addEventListener('click', () => handleImageGeneration(1));
            DOMElements.generateFourBtn.addEventListener('click', () => handleImageGeneration(4));
        }
        function updateUserInfo(uid, nickname) { DOMElements.userInfo.textContent = `‰ΩøÁî®ËÄÖID: ${uid ? `...${uid.slice(-6)}` : 'N/A'} (${nickname})`; }
        
        // --- gmain.js (Main Logic) ---
        window.onload = () => {
            initState(getInitialState());
            initializeUI();

            subscribe('activeStyleId', (styleId) => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.textContent === styles.find(s => s.id === styleId).title));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `content-${styleId}`));
            });
            
            subscribe('favorites', (favorites) => {
                if(favorites === null) return;
                DOMElements.favoritesCount.textContent = favorites.length;
                // Simple render for test
                const gallery = document.querySelector('.card-container');
                if(gallery && !window.hasInitialImagesGenerated) {
                    window.hasInitialImagesGenerated = true;
                    if(favorites.length > 0) {
                         const card = createImageCard({ ...favorites[0], src: favorites[0].imageUrl, isLiked: true }, getCardHandlers());
                         gallery.appendChild(card);
                    }
                }
            });

            if (initFirebase()) {
                handleAuthentication(onUserSignedIn);
            } else {
                showMessage(uiMessages.errors.firebaseInit, true);
            }
        };

        async function onUserSignedIn(uid, error) {
            if (uid) {
                const userData = await getUserData(db, uid);
                updateUserInfo(uid, userData.nickname);
                await initDailyTaskManager(db, uid);
                await initAnalyticsManager(db, uid);
                listenToFavorites((favs) => setState({ favorites: favs }));
                
                document.getElementById('loading-overlay').classList.add('hidden');
                document.querySelector('.main-container').style.opacity = '1';
            } else {
                showMessage(uiMessages.errors.cloudConnect, true);
            }
        }

    </script>
</body>
</html>
