<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP 穩固基礎 - 後端初始化測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0c0a18; }
        .status-log li { transition: all 0.3s ease; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="text-center p-6 bg-gray-800 rounded-lg shadow-xl max-w-lg mx-auto w-full">
        <h1 class="text-xl font-bold text-white mb-4">MVP 穩固基礎測試</h1>
        <ol id="status-log" class="text-left space-y-2 text-gray-300 text-sm">
            <!-- 測試日誌會顯示在這裡 -->
        </ol>
    </div>

    <script type="module">
        // --- Firebase CDN Imports ---
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, writeBatch, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const logList = document.getElementById('status-log');
        
        // --- 輔助函式 ---
        function logStatus(message, isSuccess = null) {
            const li = document.createElement('li');
            let statusIcon = '⏳';
            if (isSuccess === true) statusIcon = '✅';
            if (isSuccess === false) statusIcon = '❌';
            
            li.innerHTML = `${statusIcon} ${message}`;
            
            if (isSuccess === true) li.classList.add('text-green-400');
            if (isSuccess === false) li.classList.add('text-red-400', 'font-bold');
            
            logList.appendChild(li);
        }

        // --- 整合所有 JS 檔案的邏輯 (已驗證部分) ---

        // --- 設定檔 (app-config.js & game-config.js) ---
        const serviceKeys = { firebaseConfig: { apiKey: "AIzaSyDbWa8TWru1J048WK8msVBaC9JhhhtuhJw", authDomain: "goddess-chance.firebaseapp.com", projectId: "goddess-chance", storageBucket: "goddess-chance.appspot.com", messagingSenderId: "440990936442", appId: "1:440990936442:web:37d864cd13112f14913ac3" }};
        const dbCollectionNames = { users: 'users', dailyTasks: 'dailyTasks', statistics: 'statistics', userStats: 'userStats', favorites: 'favorites' };
        const gameSettings = { dailyLimits: { generateOne: 20, generateFour: 2, gacha: 20, tts: 3 } };
        const userStatsStructure = { likes: 0, unlikes: 0, shares: 0 };
        const randomNicknames = ["D槽女神官", "波多野結冰"];

        // --- DailyTaskManager (已修正語法) ---
        class DailyTask {
            constructor(taskName, db, userId) { this.name = taskName; this.db = db; this.userId = userId; this.defaultCount = gameSettings.dailyLimits[taskName]; this.state = { count: this.defaultCount, lastUpdate: null, }; this.docRef = doc(this.db, dbCollectionNames.users, userId, dbCollectionNames.dailyTasks, this.name); this.isInitialized = false; }
            async _checkAndSync() { if (this.isInitialized && this.state.lastUpdate === new Date().toISOString().split('T')[0]) { return; } const today = new Date().toISOString().split('T')[0]; const docSnap = await getDoc(this.docRef); if (docSnap.exists()) { const dbState = docSnap.data(); if (dbState.lastUpdate === today) { this.state = dbState; } else { this.state.count = Math.max(dbState.count, this.defaultCount); this.state.lastUpdate = today; await this._save(); } } else { this.state.count = this.defaultCount; this.state.lastUpdate = today; await this._save(); } this.isInitialized = true; }
            async _save() { await setDoc(this.docRef, this.state); }
            async getCount() { await this._checkAndSync(); return this.state.count; }
        }
        const tasks = {};
        async function initDailyTaskManager(db, uid) { for (const taskName in gameSettings.dailyLimits) { tasks[taskName] = new DailyTask(taskName, db, uid); await tasks[taskName].getCount(); } }
        
        // --- AnalyticsManager ---
        let statsRef;
        async function initAnalyticsManager(db, uid) { statsRef = doc(db, 'users', uid, 'statistics', 'userStats'); const docSnap = await getDoc(statsRef); if (!docSnap.exists()) { const nickname = randomNicknames[Math.floor(Math.random() * randomNicknames.length)]; const userDocRef = doc(db, 'users', uid); await Promise.all([ setDoc(statsRef, { ...userStatsStructure, firstLogin: serverTimestamp(), lastLogin: serverTimestamp() }), setDoc(userDocRef, { nickname: nickname }) ]); } else { await setDoc(statsRef, { lastLogin: serverTimestamp() }, { merge: true }); } }

        // --- gfirebase (核心部分) ---
        let currentUserId;
        function getCurrentUserId() { return currentUserId; }
        async function getUserData(db, uid) { if (!uid) return null; const userRef = doc(db, dbCollectionNames.users, uid); const docSnap = await getDoc(userRef); return docSnap.exists() ? docSnap.data() : { nickname: '無名氏' }; }
        function listenToFavorites(db, uid, callback) { const favoritesCol = collection(db, dbCollectionNames.users, uid, dbCollectionNames.favorites); return onSnapshot(favoritesCol, (snapshot) => callback(snapshot.docs.map(d => d.data()), null), (error) => callback([], error)); }

        // --- 主測試流程 ---
        async function runFullTest() {
            let app, auth, db, user;
            try {
                logStatus("1. 初始化 Firebase...");
                app = initializeApp(serviceKeys.firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                logStatus("Firebase 初始化成功。", true);

                logStatus("2. 正在匿名登入...");
                const userCredential = await signInAnonymously(auth);
                user = userCredential.user;
                currentUserId = user.uid;
                logStatus(`匿名登入成功 (ID: ...${user.uid.slice(-6)})`, true);

                logStatus("3. 初始化每日任務管理器...");
                await initDailyTaskManager(db, user.uid);
                logStatus("每日任務管理器初始化成功。", true);

                logStatus("4. 初始化分析管理器...");
                await initAnalyticsManager(db, user.uid);
                logStatus("分析管理器初始化成功。", true);

                logStatus("5. 啟動『我的最愛』即時監聽...");
                const unsubscribe = listenToFavorites(db, user.uid, (favorites, error) => {
                    if (error) {
                        logStatus(`監聽『我的最愛』失敗: ${error.message}`, false);
                    } else {
                        logStatus(`成功接收到 ${favorites.length} 筆『我的最愛』資料。`, true);
                        logStatus("🎉 所有後端服務初始化成功！", true);
                        unsubscribe(); // 收到一次回饋後就停止監聽
                    }
                });

            } catch (error) {
                console.error("測試過程中發生致命錯誤:", error);
                logStatus(`測試失敗: ${error.message}`, false);
            }
        }

        runFullTest();
    </script>

</body>
</html>
