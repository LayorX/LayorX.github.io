<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoddeSpark (æœ€çµ‚ç©©å®šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0c0a18; color: #F3F4F6; }
        .main-container { opacity: 0; transition: opacity 1s ease-in-out; }
        .sticky-header { position: sticky; top: 0; z-index: 100; background-color: rgba(12, 10, 24, 0.85); padding-top: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tab-button { border-bottom: 3px solid transparent; }
        .tab-button.active { color: #EC4899; border-bottom-color: #EC4899; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn-base { transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(45deg, #EC4899, #8B5CF6); }
        .btn-secondary { background: linear-gradient(45deg, #4f46e5, #8b5cf6); }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        
        /* âœ¨ FIX: ç°¡åŒ–å¡ç‰‡ CSSï¼Œç§»é™¤å‹•ç•«ä¸¦ä½¿ç”¨ç›¸å®¹æ€§é«˜çš„é•·å¯¬æ¯”æŠ€å·§ */
        .image-card {
            background-color: rgba(31, 41, 55, 0.5);
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
            height: 0;
            padding-bottom: 150%; /* 3:2 aspect ratio (150%) */
        }
        .image-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 0.75rem; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; align-items: center; z-index: 5; }
        .like-btn { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: rgba(255, 255, 255, 0.7); }
        .like-btn.liked { color: #ef4444; }
    </style>
</head>
<body class="p-4">

    <!-- æ¸¬è©¦æ—¥èªŒ -->
    <div id="test-log-container" class="fixed top-0 left-0 w-full bg-black bg-opacity-80 text-white p-2 z-50 text-xs font-mono max-h-48 overflow-y-auto">
        <h2 class="font-bold">[åµéŒ¯æ—¥èªŒ]</h2>
        <ol id="status-log" class="space-y-1"></ol>
    </div>

    <!-- å®Œæ•´çš„ App HTML çµæ§‹ -->
    <div class="main-container pt-16">
        <header class="sticky-header">
            <div class="container mx-auto px-4">
                <h1 id="header-title" class="text-3xl md:text-4xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500 mb-2"></h1>
                <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 my-4">
                    <button id="generate-one-btn" class="btn-base btn-primary text-white font-bold py-2 px-6 rounded-full text-lg"></button>
                    <button id="generate-four-btn" class="btn-base btn-secondary text-white font-bold py-2 px-6 rounded-full text-lg"></button>
                    <button id="favorites-btn" class="btn-base btn-primary text-white font-bold py-2 px-6 rounded-full text-lg"><span id="favorites-btn-text"></span> â¤ï¸ <span id="favorites-count">0</span></button>
                </div>
                <nav id="tab-navigation" class="flex justify-center border-b border-gray-700"></nav>
                <div id="user-info" class="text-center text-xs text-gray-500 py-1"></div>
            </div>
        </header>
        <main id="style-sections" class="container mx-auto px-4"></main>
    </div>

    <script type="module">
        // --- Firebase CDN Imports ---
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, query, limit, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const logList = document.getElementById('status-log');
        function logStatus(message, isSuccess = null) {
            const li = document.createElement('li');
            let statusIcon = 'â³';
            if (isSuccess === true) statusIcon = 'âœ…';
            if (isSuccess === false) statusIcon = 'âŒ';
            li.innerHTML = `${statusIcon} ${message}`;
            if (isSuccess === true) li.classList.add('text-green-400');
            if (isSuccess === false) li.classList.add('text-red-400', 'font-bold');
            logList.appendChild(li);
            li.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        // --- è¨­å®šæª” ---
        const appInfo = { title: "å¥³ç¥æ…¾è¦‹GoddeSpark", version: "1.6.63" };
        const serviceKeys = { firebaseConfig: { apiKey: "AIzaSyDbWa8TWru1J048WK8msVBaC9JhhhtuhJw", authDomain: "goddess-chance.firebaseapp.com", projectId: "goddess-chance", storageBucket: "goddess-chance.appspot.com", messagingSenderId: "440990936442", appId: "1:440990936442:web:37d864cd13112f14913ac3" }};
        const styles = [{ id: "beach-silhouette", title: "ğŸ–ï¸ å¤æ—¥æˆ€æ›²", description: "æµ·ç˜ã€æ€§æ„Ÿï¼ŒèåŒ–ä½ å¿ƒçš„å¤æ—¥æµ·ç˜æˆ€æ›²" }, { id: "morning-lazy", title: "â˜€ï¸ æ™¨å…‰ç§æˆ¿", description: "æ…µæ‡¶ã€ç§å¯†ã€å±¬æ–¼ä½ çš„å¥³å‹æ„Ÿç¬é–“" }];
        const uiMessages = { buttons: { generateOne: "é‡è¦‹ä¸€ä½", generateFour: "é‡è¦‹å››ä½", favorites: "å¥³ç¥æ®¿å ‚" } };
        const gameSettings = { gachaQueryLimit: 100 };

        // --- ç‹€æ…‹ç®¡ç†å™¨ ---
        let _state = {};
        const _subscribers = {};
        function initState(initialState) { _state = initialState; }
        function getState(key) { return _state[key]; }
        function setState(newState) { for (const key in newState) { if (Object.prototype.hasOwnProperty.call(newState, key)) { if (_state[key] !== newState[key]) { _state[key] = newState[key]; if (_subscribers[key]) { _subscribers[key].forEach(callback => callback(_state[key])); } } } } }
        function subscribe(key, callback) { if (!_subscribers[key]) { _subscribers[key] = []; } _subscribers[key].push(callback); if (key in _state) { callback(_state[key]); } }
        function getInitialState() { return { activeStyleId: styles[0].id, favorites: null, userNickname: '' }; }

        // --- Firebase æ ¸å¿ƒ ---
        let db, auth, currentUserId;
        async function getUserData(uid) { const userRef = doc(db, 'users', uid); const userDocSnap = await getDoc(userRef); return userDocSnap.exists() ? userDocSnap.data() : { nickname: 'ç„¡åæ°' }; }
        function listenToFavorites(callback) { onSnapshot(collection(db, 'users', currentUserId, 'favorites'), (snapshot) => { const favs = snapshot.docs.map(d => d.data()); callback(favs); }); }
        async function getRandomGoddessesFromDB(count) { const q = query(collection(db, "public-goddesses"), limit(gameSettings.gachaQueryLimit)); const snapshot = await getDocs(q); if (snapshot.empty) { return []; } const allDocs = snapshot.docs.map(doc => doc.data()); const shuffled = allDocs.sort(() => 0.5 - Math.random()); return shuffled.slice(0, count); }
        async function removeFavorite(favoriteToRemove) { const favoriteRef = doc(db, 'users', currentUserId, 'favorites', favoriteToRemove.id); await deleteDoc(favoriteRef); }
        async function saveFavorite(favoriteData) { const favoriteRef = doc(db, 'users', currentUserId, 'favorites', favoriteData.id); await setDoc(favoriteRef, { id: favoriteData.id, style: favoriteData.style, imageUrl: favoriteData.imageUrl }); }

        // --- Handlers (äº’å‹•é‚è¼¯) ---
        async function toggleFavorite(imageData) {
            logStatus(`Handler: Toggling favorite for image ${imageData.id}`);
            const favorites = getState('favorites');
            if (favorites === null) return;
            const isLiked = favorites.some(fav => fav.id === imageData.id);
            if (isLiked) {
                await removeFavorite(imageData);
            } else {
                await saveFavorite({ id: imageData.id, style: imageData.style, imageUrl: imageData.imageUrl || imageData.src });
            }
        }
        function getCardHandlers() { return { onLike: toggleFavorite }; }

        // --- GUI (å¡ç‰‡æ¸²æŸ“æ ¸å¿ƒ) ---
        // âœ¨ FIX: æ¥µåº¦ç°¡åŒ–å¡ç‰‡æ¸²æŸ“é‚è¼¯ï¼Œç§»é™¤æ‰€æœ‰å‹•ç•«å’Œè¤‡é›œçµæ§‹
        function createImageCard(imageData, handlers) {
            logStatus(`GUI: Creating simplified image card for ${imageData.id}`);
            const { style, id, isLiked } = imageData;
            const displaySrc = imageData.resizedUrl || imageData.imageUrl || imageData.src;
            
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            imageCard.dataset.id = id;
            
            const cardHTML = `
                <img alt="${style ? style.title : 'Gacha Image'}" loading="lazy">
                <div class="card-footer">
                    <button class="like-btn ${isLiked ? 'liked' : ''}">â™¥</button>
                </div>`;
            imageCard.innerHTML = cardHTML;

            const img = imageCard.querySelector('img');
            img.src = displaySrc;
            img.onerror = () => { imageCard.innerHTML = `<p class="p-4 text-red-400">åœ–ç‰‡è¼‰å…¥å¤±æ•—</p>`; };

            imageCard.querySelector('.like-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                handlers.onLike(imageData);
            });
            return imageCard;
        }

        // --- UI ç®¡ç†å™¨ ---
        let DOMElements = {};
        function initializeUI() { DOMElements = { headerTitle: document.getElementById('header-title'), tabNavigation: document.getElementById('tab-navigation'), styleSectionsContainer: document.getElementById('style-sections'), generateOneBtn: document.getElementById('generate-one-btn'), generateFourBtn: document.getElementById('generate-four-btn'), favoritesBtn: document.getElementById('favorites-btn'), favoritesBtnText: document.getElementById('favorites-btn-text'), favoritesCount: document.getElementById('favorites-count'), userInfo: document.getElementById('user-info'), }; DOMElements.headerTitle.innerHTML = `${appInfo.title} <span class="text-base align-middle text-gray-400 font-medium">v${appInfo.version}</span>`; DOMElements.generateOneBtn.textContent = uiMessages.buttons.generateOne; DOMElements.generateFourBtn.textContent = uiMessages.buttons.generateFour; DOMElements.favoritesBtnText.textContent = uiMessages.buttons.favorites; styles.forEach((style, index) => { const tabButton = document.createElement('button'); tabButton.className = `tab-button text-md font-medium py-2 px-4 text-gray-400 ${index === 0 ? 'active' : ''}`; tabButton.textContent = style.title; tabButton.dataset.styleId = style.id; DOMElements.tabNavigation.appendChild(tabButton); const section = document.createElement('section'); section.id = `content-${style.id}`; section.className = `tab-content ${index === 0 ? 'active' : ''}`; section.innerHTML = `<div class="text-center mb-8 mt-4"><p class="text-gray-400 mt-1">${style.description}</p></div><div id="${style.id}-gallery" class="card-container mb-8"></div>`; DOMElements.styleSectionsContainer.appendChild(section); }); document.querySelectorAll('.tab-button').forEach(button => { button.addEventListener('click', () => setState({ activeStyleId: button.dataset.styleId })); }); }
        function updateUserInfo(uid, nickname) { if (DOMElements.userInfo) { const uidText = uid ? `...${uid.slice(-6)}` : 'å°šæœªç™»å…¥'; DOMElements.userInfo.innerHTML = `é›²ç«¯ä½¿ç”¨è€… (${nickname}) ID: ${uidText}`; } }
        
        // --- åˆå§‹åœ–ç‰‡è¼‰å…¥ ---
        let hasInitialImagesGenerated = false;
        async function generateInitialImages(favorites) {
            if (hasInitialImagesGenerated) return;
            hasInitialImagesGenerated = true;
            logStatus("æ­£åœ¨è¼‰å…¥åˆå§‹åœ–ç‰‡...");

            for (const fav of favorites) {
                if (!fav || !fav.style || !fav.style.id) continue;
                const gallery = document.getElementById(`${fav.style.id}-gallery`);
                if (gallery) {
                    const imageData = { ...fav, isLiked: true };
                    const imageCard = createImageCard(imageData, getCardHandlers());
                    gallery.appendChild(imageCard);
                }
            }

            if (favorites.length < 4) {
                try {
                    const randomGoddesses = await getRandomGoddessesFromDB(4);
                    logStatus(`å¾è³‡æ–™åº«æŠ“å–äº† ${randomGoddesses.length} å¼µéš¨æ©Ÿå¥³ç¥ã€‚`, true);
                    for (const goddess of randomGoddesses) {
                        if (document.querySelector(`.image-card[data-id="${goddess.id}"]`)) continue;
                        const gallery = document.getElementById(`${goddess.style.id}-gallery`);
                        if (gallery) {
                            const imageData = { ...goddess, isLiked: favorites.some(fav => fav.id === goddess.id) };
                            const imageCard = createImageCard(imageData, getCardHandlers());
                            gallery.appendChild(imageCard);
                        }
                    }
                } catch (error) {
                    logStatus(`æŠ“å–åˆå§‹éš¨æ©Ÿå¥³ç¥å¤±æ•—: ${error.message}`, false);
                }
            }
            logStatus("åˆå§‹åœ–ç‰‡è¼‰å…¥å®Œç•¢ã€‚", true);
        }

        function setupSubscriptions() {
            subscribe('activeStyleId', (styleId) => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.styleId === styleId));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `content-${styleId}`));
            });
            subscribe('favorites', (favorites) => {
                if (favorites !== null) {
                    DOMElements.favoritesCount.textContent = favorites.length;
                    generateInitialImages(favorites);
                    document.querySelectorAll('.image-card').forEach(card => {
                        const likeBtn = card.querySelector('.like-btn');
                        if (likeBtn) {
                            const isLiked = favorites.some(fav => fav.id === card.dataset.id);
                            likeBtn.classList.toggle('liked', isLiked);
                        }
                    });
                }
            });
        }

        // --- ä¸»æ¸¬è©¦æµç¨‹ ---
        async function runFullTest() {
            let app, user;
            try {
                logStatus("1. åˆå§‹åŒ– Firebase...");
                app = initializeApp(serviceKeys.firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                logStatus("Firebase åˆå§‹åŒ–æˆåŠŸã€‚", true);

                logStatus("2. æ­£åœ¨åŒ¿åç™»å…¥...");
                const userCredential = await signInAnonymously(auth);
                user = userCredential.user;
                currentUserId = user.uid;
                logStatus(`åŒ¿åç™»å…¥æˆåŠŸ (ID: ...${user.uid.slice(-6)})`, true);
                
                logStatus("3. æ­£åœ¨åˆå§‹åŒ– App ç‹€æ…‹...");
                initState(getInitialState());
                logStatus("App ç‹€æ…‹åˆå§‹åŒ–å®Œç•¢ã€‚", true);

                logStatus("4. æ­£åœ¨åˆå§‹åŒ– UI ä»‹é¢...");
                initializeUI();
                setupSubscriptions();
                logStatus("UI ä»‹é¢åˆå§‹åŒ–å®Œç•¢ã€‚", true);
                
                logStatus("5. æ­£åœ¨å–å¾—ä½¿ç”¨è€…è³‡æ–™...");
                const userData = await getUserData(user.uid);
                updateUserInfo(user.uid, userData.nickname);
                logStatus(`ä½¿ç”¨è€…è³‡æ–™å–å¾—å®Œç•¢ (Nickname: ${userData.nickname})`, true);

                logStatus("6. å•Ÿå‹•ã€æˆ‘çš„æœ€æ„›ã€å³æ™‚ç›£è½...");
                listenToFavorites((favs) => {
                    setState({ favorites: favs });
                });
                
                logStatus("ğŸ‰ App æ ¸å¿ƒå•Ÿå‹•æˆåŠŸï¼é¡¯ç¤ºä¸»ç•«é¢...", true);
                document.querySelector('.main-container').style.opacity = '1';

            } catch (error) {
                console.error("æ¸¬è©¦éç¨‹ä¸­ç™¼ç”Ÿè‡´å‘½éŒ¯èª¤:", error);
                logStatus(`æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        runFullTest();
    </script>

</body>
</html>
