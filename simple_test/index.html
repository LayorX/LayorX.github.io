<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³å°æ¦‚å¿µäº’å‹•å¼å°è¦½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* Stone 100 */
            color: #292524; /* Stone 800 */
        }
        .step-card {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
            display: none;
        }
        .step-card.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }
        .choice-card {
            border: 2px solid #e7e5e4; /* Stone 200 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .choice-card:hover {
            border-color: #0ea5e9; /* Sky 500 */
            transform: translateY(-5px);
        }
        .choice-card.selected {
            border-color: #0ea5e9; /* Sky 500 */
            background-color: #f0f9ff; /* Sky 50 */
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.3);
        }
        .long-press-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            margin-top: -40px;
            margin-left: -40px;
            border-radius: 50%;
            background-color: rgba(14, 165, 233, 0.2);
            transform: scale(0.5);
            opacity: 0;
            transition: all 0.2s ease-out;
            pointer-events: none;
            z-index: 10;
        }
        .long-press-indicator.pressing {
            opacity: 1;
            transform: scale(1);
        }
        .long-press-indicator::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 4px solid #0ea5e9;
            clip-path: polygon(50% 50%, 50% 0, 0 0, 0 100%, 100% 100%, 100% 0, 50% 0);
            transform: rotate(var(--angle, -90deg));
            transition: none;
        }
        .menu-template {
            position: fixed;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 0.5rem;
            display: none;
            flex-direction: column;
            gap: 0.25rem;
            z-index: 50;
            width: max-content;
            animation: scale-up 0.2s ease-out;
        }
        .menu-template.active {
            display: flex;
        }
        @keyframes scale-up {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .menu-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .menu-btn:hover {
            background-color: #f4f4f5; /* Zinc 100 */
        }
        .rating-btn.selected {
            background-color: #0ea5e9;
            color: white;
        }
        .tag-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid #d4d4d8; /* Zinc 300 */
            border-radius: 9999px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .tag-btn.selected {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            border-color: #3b82f6;
        }
        .info-modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; transition: opacity 0.2s ease-in-out;
            pointer-events: none;
        }
        .info-modal-backdrop.active {
            opacity: 1; pointer-events: auto;
        }
        .info-modal-content {
            background: white; padding: 2rem; border-radius: 1rem;
            max-width: 90%; width: 500px; text-align: center;
            transform: scale(0.95); transition: transform 0.2s ease-in-out;
            position: relative;
        }
        .info-modal-backdrop.active .info-modal-content {
            transform: scale(1);
        }
        .flooding-comment {
            position: absolute;
            background: #fecaca;
            border: 1px solid #ef4444;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            opacity: 0;
            animation: simple-flood-and-fade 4s ease-out forwards;
        }
        @keyframes simple-flood-and-fade {
            0% { opacity: 0; transform: scale(0.8); }
            25% { opacity: 1; transform: scale(1); }
            75% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); }
        }
    </style>
</head>
<body class="antialiased">

    <main class="container mx-auto p-4 md:p-8 max-w-3xl">
        <div id="onboarding-flow">
            <!-- Steps 1-7 remain the same -->
            <div id="step-1" class="step-card active text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-sky-900 mb-4">æ­¡è¿ä¾†åˆ°ä¸€å€‹éœ€è¦æ€è€ƒçš„ç¤¾ç¾¤</h1>
                <p class="text-stone-600 mb-8">åœ¨é€™è£¡ï¼Œæ‚¨çš„åˆ¤æ–·åŠ›æ¯”è²é‡æ›´é‡è¦ã€‚</p>
                <button data-next="step-2" class="next-btn bg-sky-700 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-800 transition-transform transform hover:scale-105">é–‹å§‹æˆ‘çš„æŒ‘æˆ°</button>
<button  class="next-btn bg-sky-700 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-800 transition-transform transform hover:scale-105" onclick="window.location.href='api test key test.html'">Gemini AI test</button>
<button  class="next-btn bg-sky-700 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-800 transition-transform transform hover:scale-105" onclick="window.location.href='../index.html'">æˆ‘çš„ç¶²é </button>
            </div>

            <div id="step-2" class="step-card">
                <h2 class="text-2xl font-bold text-center mb-2">æ‚¨çš„ç¬¬ä¸€å€‹æŒ‘æˆ°</h2>
                <p class="text-center text-stone-500 mb-8">è¿‘æœŸæœ‰ä¸€å€‹é—œæ–¼ã€ŒAI æ˜¯å¦æœƒå–ä»£äººé¡å·¥ä½œã€çš„ç†±é–€è¨è«–ï¼Œä»¥ä¸‹æœ‰å…©å‰‡è©•è«–ï¼Œè«‹æ‚¨åˆ¤æ–·å“ªä¸€å‰‡æ›´æœ‰åƒè€ƒåƒ¹å€¼ï¼Ÿ</p>
                <div id="challenge-container" class="space-y-4 relative overflow-hidden rounded-lg p-2 -m-2">
                    <div id="choice-a" class="choice-card">
                        <p class="font-bold">è©•è«– A</p>
                        <p class="text-stone-700 mt-2">ã€ŒAI å°±æ˜¯å€‹åƒåœ¾ï¼åªæœƒæ¶èµ°æˆ‘å€‘çš„å·¥ä½œï¼Œæ”¿åºœæ‡‰è©²å…¨é¢ç¦æ­¢ï¼ã€</p>
                    </div>
                    <div id="choice-b" class="choice-card">
                        <p class="font-bold">è©•è«– B</p>
                        <p class="text-stone-700 mt-2">ã€Œæ ¹æ“šç‰›æ´¥å¤§å­¸çš„ç ”ç©¶å ±å‘Šï¼ˆé™„é€£çµï¼‰ï¼ŒAI åœ¨é‡è¤‡æ€§é«˜çš„è·ä½ä¸Šå–ä»£æ€§è¼ƒå¼·ï¼Œä½†åœ¨éœ€è¦å‰µæ„èˆ‡åŒç†å¿ƒçš„é ˜åŸŸä»æœ‰ä¾·é™ã€‚æˆ‘èªç‚ºæˆ‘å€‘æ‡‰è©²å°ˆæ³¨æ–¼å¦‚ä½•èˆ‡ AI å”ä½œã€‚ã€</p>
                    </div>
                </div>
            </div>

            <div id="step-3" class="step-card text-center">
                <div class="text-5xl mb-4">ğŸ‰</div>
                <h2 class="text-3xl font-bold text-green-600 mb-4">ç²¾å½©çš„åˆ¤æ–·ï¼</h2>
                <p class="text-stone-700 text-lg mb-4">æ‚¨çš„é¸æ“‡èˆ‡ç¤¾ç¾¤ä¸­ 85% çš„é«˜ä¿¡ä»»åº¦ç”¨æˆ¶ä¸€è‡´ã€‚åœ¨é€™è£¡ï¼Œæˆ‘å€‘é‡è¦–çš„æ˜¯<strong class="text-sky-800">è­‰æ“š</strong>èˆ‡<strong class="text-sky-800">ç†æ€§</strong>ï¼Œè€Œéå–®ç´”çš„è²é‡ã€‚</p>
                <div class="bg-sky-50 p-4 rounded-lg">
                    <p class="font-bold">æŒ‡æ¨™åˆç™»å ´</p>
                    <p class="text-stone-600 mt-1">æ‚¨çš„<strong class="text-sky-800">æ·±åº¦å€¼</strong>å› æ­¤ç²å¾—äº†åˆå§‹åˆ†æ•¸ï¼Œç­‰ç´šç‚º <span class="font-mono bg-sky-200 text-sky-800 px-2 py-1 rounded">E</span>ã€‚é€™å€‹æŒ‡æ¨™ä»£è¡¨æ‚¨æ¢ç´¢ä¸åŒè§€é»çš„æ„é¡˜ã€‚</p>
                </div>
                <button data-next="step-4" class="next-btn mt-8 bg-sky-700 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-800 transition-transform transform hover:scale-105">ç¹¼çºŒå­¸ç¿’</button>
            </div>

            <div id="step-4" class="step-card">
                <h2 class="text-2xl font-bold text-center mb-2">å­¸ç¿’æˆ‘å€‘çš„ã€Œè©•åƒ¹è§€é»ã€</h2>
                <div id="rating-context-container" class="mb-6 bg-stone-100 p-4 rounded-lg border-l-4 border-stone-300">
                    <p class="text-sm text-stone-500 mb-2">æƒ…å¢ƒï¼šé‡å°ä»¥ä¸‹é€™å‰‡**æœ‰è­‰æ“š**çš„è§€é»...</p>
                    <p class="font-bold">è©•è«– B</p>
                    <p class="text-stone-700 mt-1">ã€Œæ ¹æ“šç‰›æ´¥å¤§å­¸çš„ç ”ç©¶å ±å‘Šï¼ˆé™„é€£çµï¼‰ï¼ŒAI åœ¨é‡è¤‡æ€§é«˜çš„è·ä½ä¸Šå–ä»£æ€§è¼ƒå¼·ï¼Œä½†åœ¨éœ€è¦å‰µæ„èˆ‡åŒç†å¿ƒçš„é ˜åŸŸä»æœ‰ä¾·é™ã€‚æˆ‘èªç‚ºæˆ‘å€‘æ‡‰è©²å°ˆæ³¨æ–¼å¦‚ä½•èˆ‡ AI å”ä½œã€‚ã€</p>
                </div>
                <div id="rating-tutorial-container">
                </div>
            </div>
            
            <div id="step-5" class="step-card text-center">
                 <div class="text-5xl mb-4">ğŸŒŸ</div>
                <h2 class="text-3xl font-bold text-green-600 mb-4">å®Œç¾çš„è©•åƒ¹ï¼</h2>
                <p class="text-stone-700 text-lg mb-4">æ‚¨å‰›å‰›å®Œæˆäº†ä¸€æ¬¡é«˜å“è³ªçš„äº’å‹•ï¼š<strong class="text-sky-800">å³ä½¿èªåŒç«‹å ´ï¼Œä¹Ÿå®¢è§€æŒ‡å‡ºäº†å…¶è«–è¿°çš„ä¸è¶³ã€‚</strong></p>
                 <div class="bg-sky-50 p-4 rounded-lg">
                    <p class="font-bold">æŒ‡æ¨™ç™»å ´</p>
                    <p class="text-stone-600 mt-1">æ‚¨çš„<strong class="text-sky-800">ä¿¡ä»»å€¼</strong>å› æ­¤ç²å¾—äº†åˆå§‹åˆ†æ•¸ï¼Œç­‰ç´šç‚º <span class="font-mono bg-sky-200 text-sky-800 px-2 py-1 rounded">E</span>ã€‚å®ƒä»£è¡¨æ‚¨åˆ¤æ–·çš„å¯é ç¨‹åº¦ã€‚å¤šèŠ±é€™å…©ç§’é˜ï¼Œå°±æ˜¯å°ç¤¾ç¾¤æœ€æœ‰åŠ›çš„è²¢ç»ã€‚</p>
                </div>
                <button data-next="step-6" class="next-btn mt-8 bg-sky-700 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-800 transition-transform transform hover:scale-105">æˆ‘æ˜ç™½äº†</button>
            </div>

            <div id="step-6" class="step-card">
                <h2 class="text-2xl font-bold text-center mb-8">èªè­˜æ‚¨çš„æ–°èº«ä»½</h2>
                <div class="bg-white p-6 rounded-lg shadow-inner border">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-stone-300 rounded-full"></div>
                        <div>
                            <p class="font-bold">ç”¨æˆ¶A</p>
                            <div class="flex items-center space-x-2 text-sm font-mono">
                                <span>ä¿¡: <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded">A+ <span class="text-green-600">â†‘</span></span></span>
                                <span>æ·±: <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded">B <span class="text-gray-500">â”€</span></span></span>
                                <span>è²¢: <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">S <span class="text-red-600">â†“</span></span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 space-y-4 text-stone-700">
                    <p>åœ¨æœ¬å¹³å°ï¼Œæˆ‘å€‘ç”¨ <strong class="text-sky-800">SS, S, A, B, C...</strong> ç­‰ç´šä¾†ä»£è¡¨æ‚¨çš„å½±éŸ¿åŠ›ï¼Œè€Œéå†°å†·çš„æ•¸å­—ã€‚</p>
                    <p>æ‚¨çš„ç›®æ¨™æ˜¯æå‡<strong class="text-sky-800">å“è³ªå€é–“</strong>ï¼Œè€Œä¸æ˜¯è¿½æ±‚åˆ†æ•¸ç«¶è³½ã€‚</p>
                    <p>æ—é‚Šçš„ç®­é ­ <strong class="text-sky-800">â†‘ â”€ â†“</strong> ä»£è¡¨æ‚¨è¿‘æœŸçš„<strong class="text-sky-800">åŠªåŠ›è¶¨å‹¢</strong>ã€‚å³ä½¿ç­‰ç´šå°šæœªæå‡ï¼Œä¸€å€‹å‘ä¸Šçš„ç®­é ­ä¹Ÿè­‰æ˜æ‚¨çš„è²¢ç»æ­£è¢«çœ‹è¦‹ï¼</p>
                </div>
                <div class="text-center">
                    <button data-next="step-7" class="next-btn mt-8 bg-sky-700 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-800 transition-transform transform hover:scale-105">é–‹å§‹æˆ‘çš„æ—…ç¨‹ï¼</button>
                </div>
            </div>
            
            <div id="step-7" class="step-card text-center">
                <h2 class="text-3xl md:text-4xl font-bold text-sky-900 mb-6">æ­å–œæ‚¨ï¼Œå·²å®Œæˆæ‰€æœ‰è¨“ç·´ã€‚</h2>
                <div class="space-y-4 text-lg text-stone-600">
                    <p>é€™å€‹å¹³å°çš„ä¿¡ä»»åº¦ï¼Œä¸æ˜¯ç”±æˆ‘å€‘æˆ– AI æ±ºå®šï¼Œè€Œæ˜¯ç”±ç¤¾ç¾¤ä¸­çš„æ¯ä¸€å€‹ã€Œæ‚¨ã€æ‰€å…±åŒå®šç¾©ã€‚</p>
                    <p>æ‚¨æ¯ä¸€æ¬¡<strong class="text-sky-800">ä¸é¡˜ç›²å¾çš„ã€å­˜ç–‘ã€‘</strong>ï¼Œæ¯ä¸€æ¬¡<strong class="text-sky-800">å®¢è§€çš„ã€å“è³ªè©•åƒ¹ã€‘</strong>ï¼Œéƒ½æ˜¯åœ¨ç‚ºé€™å€‹æ··äº‚çš„è³‡è¨Šç’°å¢ƒæ³¨å…¥ä¸€è‚¡æ¸…æµã€‚</p>
                    <p class="font-bold text-xl text-stone-800 mt-6">å› ç‚ºä½ æˆ‘çš„åŠªåŠ›ä¸æ‡¶æƒ°ï¼Œæ‰èƒ½è®“æ•´é«”çš„åª’é«”è­˜è®€èƒ½åŠ›æ›´ä¸Šä¸€å±¤æ¨“ã€‚</p>
                </div>
                 <button data-next="step-1" class="next-btn mt-10 bg-gray-600 text-white font-bold py-3 px-8 rounded-full hover:bg-gray-700 transition-transform transform hover:scale-105">é‡æ–°é–‹å§‹æ•™å­¸</button>
            </div>
        </div>
    </main>

    <div id="info-modal" class="info-modal-backdrop">
        <div id="info-modal-content" class="info-modal-content">
            <h3 id="info-modal-title" class="text-2xl font-bold text-sky-900 mb-4"></h3>
            <div id="info-modal-body" class="text-stone-600 space-y-3 relative"></div>
            <div id="info-modal-footer" class="mt-6"></div>
        </div>
    </div>

    <div id="context-menu" class="menu-template">
        <button class="menu-btn" data-action="rate">âœï¸ è©•åƒ¹è§€é»</button>
        <button class="menu-btn" data-action="report">ğŸš© èˆ‰å ±å…§å®¹</button>
        <button class="menu-btn" data-action="remove">ğŸ—‘ï¸ ç§»é™¤æˆ‘çš„è©•åƒ¹</button>
    </div>

    <div id="rating-menu" class="menu-template"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM å…ƒç´ ç²å– ---
    const steps = document.querySelectorAll('.step-card');
    const nextButtons = document.querySelectorAll('.next-btn');
    const choiceA = document.getElementById('choice-a');
    const choiceB = document.getElementById('choice-b');
    const ratingTutorialContainer = document.getElementById('rating-tutorial-container');
    const infoModal = document.getElementById('info-modal');
    const infoModalTitle = document.getElementById('info-modal-title');
    const infoModalBody = document.getElementById('info-modal-body');
    const infoModalFooter = document.getElementById('info-modal-footer');
    const contextMenu = document.getElementById('context-menu');
    const ratingMenu = document.getElementById('rating-menu');

    // --- ç‹€æ…‹ç®¡ç† ---
    let ratingState = { stance: null, quality: [] };
    let currentTutorialIndex = 0;
    let longPressTimer = null;
    let longPressIndicatorEl = null;
    let menuJustOpened = false;

    // --- æ•™å­¸å…§å®¹ ---
    const tutorialExamples = [
        { type: 'rate', text: "æˆ‘å®Œå…¨åŒæ„ B çš„çœ‹æ³•ï¼ŒAI çš„ç™¼å±•æ˜¯æ“‹ä¸ä½çš„è¶¨å‹¢ï¼Œèˆ‡å…¶ç¦æ­¢ä¸å¦‚å–„ç”¨å®ƒã€‚", instruction: "<strong>ç·´ç¿’1/4</strong>: è«‹<strong class='text-sky-800'>é•·æŒ‰</strong>é€™å‰‡è©•è«–ä¾†ã€è©•åƒ¹è§€é»ã€‘ã€‚å®ƒè¡¨é”äº†ç«‹å ´ï¼Œä½†æœ‰æå‡ºæ–°è­‰æ“šå—ï¼Ÿ", correct: { stance: 'èªåŒ', quality: ['- è­‰æ“šä¸è¶³'] } },
        { type: 'rate', text: "é€™ç¯‡æ–‡ç« çš„æ•¸æ“šæœ‰å•é¡Œï¼Œå®ƒå¼•ç”¨çš„å¸‚èª¿å ±å‘Šå·²ç¶“æ˜¯ä¸‰å¹´å‰çš„äº†ï¼Œå®Œå…¨ä¸èƒ½åæ˜ ç¾æ³ã€‚", instruction: "<strong>ç·´ç¿’2/4</strong>: é€™æ¬¡ï¼Œè«‹é»æ“Šå³ä¸‹è§’çš„<strong class='text-sky-800'>[...]æŒ‰éˆ•</strong>ï¼Œä¸¦é¸æ“‡ã€è©•åƒ¹è§€é»ã€‘ã€‚é€™å‰‡è©•è«–æå‡ºäº†å…·é«”çš„è³ªç–‘ã€‚", correct: { stance: 'å¦èª', quality: ['+ è­‰æ“šå……è¶³'] } },
        { type: 'rate-remove', text: "é€™å‰‡è©•è«–çš„è³‡è¨Šå¯èƒ½æœ‰èª¤ï¼Œæˆ‘å…ˆä¿ç•™çœ‹æ³•ã€‚", instruction: "<strong>ç·´ç¿’3/4</strong>: æœ‰æ™‚æˆ‘å€‘æœƒæ”¹è®Šå¿ƒæ„ã€‚è«‹å…ˆå°æ­¤è§€é»æŒ‰ã€å­˜ç–‘ã€‘ï¼Œç„¶å¾Œå†å¾<strong class='text-sky-800'>[...]æŒ‰éˆ•</strong>ä¸­ã€ç§»é™¤æˆ‘çš„è©•åƒ¹ã€‘ã€‚", correct: { stance: 'å­˜ç–‘', quality: [] } },
        { type: 'report', text: "æ¨“ä¸Šéƒ½æ˜¯ä¸€ç¾¤ä¸æ‡‚è£æ‡‚çš„ç™½ç—´ï¼Œæ ¹æœ¬æ²’è³‡æ ¼è¨è«–ã€‚", instruction: "<strong>ç·´ç¿’4/4</strong>: çœ‹åˆ°äººèº«æ”»æ“Šçš„è¨€è«–æ™‚ï¼Œæˆ‘å€‘å¯ä»¥ã€èˆ‰å ±å…§å®¹ã€‘ä¾†ç¶­è­·ç¤¾ç¾¤ã€‚è«‹å¾<strong class='text-sky-800'>[...]æŒ‰éˆ•</strong>ä¸­ç·´ç¿’èˆ‰å ±ã€‚" }
    ];

    // --- æ ¸å¿ƒå‡½å¼ ---

    const showStep = (stepId) => {
        steps.forEach(step => step.classList.toggle('active', step.id === stepId));
        if (stepId === 'step-4') renderTutorialExample();
    };

    const showInfoModal = (config) => {
        const { title, bodyHtml, footerHtml, onclose } = config;
        infoModalTitle.textContent = title;
        infoModalBody.innerHTML = bodyHtml;
        infoModalFooter.innerHTML = footerHtml;
        infoModal.classList.add('active');
        
        const closeModal = () => {
            infoModal.classList.remove('active');
            if (onclose) onclose();
        };

        infoModal.querySelectorAll('button[data-action="close"]').forEach(btn => {
            btn.addEventListener('click', closeModal, { once: true });
        });
    };

    const showFloodingEffect = () => {
        showInfoModal({
            title: 'å—¯...é€™å€‹é¸æ“‡æœƒè®“ä¸–ç•Œè®Šå¾—æ›´æ··äº‚å–”',
            bodyHtml: `<p>ç•¶æˆ‘å€‘èªåŒæƒ…ç·’åŒ–çš„è¨€è«–æ™‚ï¼Œæˆ‘å€‘çš„ä¸–ç•Œå°±å®¹æ˜“è¢«æ›´å¤šç›¸ä¼¼çš„è²éŸ³æ·¹æ²’ã€‚</p><p>ä¸€å€‹ç†æ€§çš„ç¤¾ç¾¤ï¼Œéœ€è¦æˆ‘å€‘ä¸€èµ·åˆ†è¾¨è³‡è¨Šçš„å“è³ªã€‚</p><p class="font-bold mt-4">æ‚¨æƒ³æ‰“é€ ä¸€å€‹æ€æ¨£çš„ç¤¾ç¾¤ï¼Ÿ</p>`,
            footerHtml: `<button data-action="close" class="bg-sky-700 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-800 transition">ä¸€å€‹ç†æ€§çš„è¨è«–ç©ºé–“</button>`,
            onclose: () => {
                showInfoModal({
                    title: 'å¾ˆæ£’çš„é¸æ“‡ï¼',
                    bodyHtml: 'è®“æˆ‘å€‘ä¸€èµ·ç‚ºç†æ€§çš„è¨è«–ç©ºé–“åŠªåŠ›ã€‚è«‹æ‚¨é‡æ–°é¸æ“‡æ›´æœ‰åƒè€ƒåƒ¹å€¼çš„è©•è«–ã€‚',
                    footerHtml: `<button data-action="close" class="bg-sky-700 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-800 transition">å¥½çš„</button>`
                });
            }
        });
        
        setTimeout(() => {
            const floodMessages = ['éƒ½æ˜¯é¨™äººçš„ï¼', 'è²¡åœ˜çš„æ‰“æ‰‹ï¼', 'å»¢æ–‡ä¸€ç¯‡', 'å°ç·¨å·¥è®€ç”Ÿï¼Ÿ', 'å¸¶é¢¨å‘ï¼'];
            const modalBodyRect = infoModalBody.getBoundingClientRect();
            if (modalBodyRect.width === 0 || modalBodyRect.height === 0) return;

            for (let i = 0; i < 5; i++) {
                const floodEl = document.createElement('div');
                floodEl.className = 'flooding-comment';
                floodEl.textContent = floodMessages[Math.floor(Math.random() * floodMessages.length)];
                
                const top = Math.random() * (modalBodyRect.height - 40);
                const left = Math.random() * (modalBodyRect.width - 120);
                floodEl.style.top = `${top}px`;
                floodEl.style.left = `${left}px`;
                floodEl.style.animationDelay = `${i * 0.3}s`;
                infoModalBody.appendChild(floodEl);
            }
        }, 100);
    };

    const renderTutorialExample = () => {
        ratingState = { stance: null, quality: [] };
        const example = tutorialExamples[currentTutorialIndex];
        const ratedCheckmark = example.rated ? `<div class="absolute top-2 right-2 text-green-500 text-2xl">âœ“</div>` : '';

        const html = `
            <p class="text-center text-stone-500 mb-4">${example.instruction}</p>
            <div id="rating-card-container" class="relative">
                <div id="rating-card" class="choice-card bg-stone-50 relative">
                    <div class="long-press-indicator"></div>
                    <p class="text-stone-700 mt-2">${example.text}</p>
                    ${ratedCheckmark}
                    <div class="absolute bottom-2 right-3">
                        <button class="more-options-btn text-stone-400 hover:text-stone-700 font-bold text-2xl leading-none">...</button>
                    </div>
                </div>
            </div>`;
        ratingTutorialContainer.innerHTML = html;
        addTutorialListeners();
    };

    const addTutorialListeners = () => {
        const ratingCard = document.getElementById('rating-card');
        const moreOptionsBtn = ratingCard.querySelector('.more-options-btn');
        longPressIndicatorEl = ratingCard.querySelector('.long-press-indicator');

        const startPress = (e) => {
            e.preventDefault();
            if (longPressTimer !== null) return;

            longPressIndicatorEl.classList.add('pressing');
            const duration = 500;
            let startTime = null;
            
            const animateProgress = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const angle = -90 + (360 * progress);
                
                if(longPressIndicatorEl) {
                    longPressIndicatorEl.style.setProperty('--angle', `${angle}deg`);
                }

                if (progress < 1 && longPressTimer) {
                    requestAnimationFrame(animateProgress);
                }
            };
            
            requestAnimationFrame(animateProgress);

            longPressTimer = setTimeout(() => {
                triggerMenu('rating', ratingCard);
                cancelPress();
            }, duration);
        };

        const cancelPress = () => {
            clearTimeout(longPressTimer);
            longPressTimer = null;
            if (longPressIndicatorEl) {
                longPressIndicatorEl.classList.remove('pressing');
                longPressIndicatorEl.style.setProperty('--angle', '-90deg');
            }
        };

        ratingCard.addEventListener('mousedown', startPress);
        ratingCard.addEventListener('mouseup', cancelPress);
        ratingCard.addEventListener('mouseleave', cancelPress);
        ratingCard.addEventListener('touchstart', startPress, { passive: false });
        ratingCard.addEventListener('touchend', cancelPress);
        ratingCard.addEventListener('touchcancel', cancelPress);
        
        moreOptionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            triggerMenu('context', moreOptionsBtn);
        });
    };

    const triggerMenu = (type, targetElement) => {
        const menu = (type === 'context') ? contextMenu : ratingMenu;
        
        const rect = targetElement.getBoundingClientRect();
        if (type === 'context') {
            menu.style.top = `${rect.top}px`;
            menu.style.left = `${rect.left}px`;
            menu.style.transform = `translate(-100%, -100%)`;
        } else {
            menu.style.top = `${rect.top + rect.height / 2}px`;
            menu.style.left = `${rect.left + rect.width / 2}px`;
            menu.style.transform = `translate(-50%, -50%)`;
        }
        
        if (type === 'context') {
            renderContextMenu();
        } else {
            renderRatingMenu();
        }
        menu.classList.add('active');
        menuJustOpened = true;
    };

    const hideAllMenus = () => {
        contextMenu.classList.remove('active');
        ratingMenu.classList.remove('active');
    };

    const renderContextMenu = () => {};

    const renderRatingMenu = () => {
        let stanceHtml = `
            <div class="flex justify-around border-b border-stone-200 pb-2 mb-2">
                <div class="menu-btn rating-btn stance-btn ${ratingState.stance === 'èªåŒ' ? 'selected' : ''}" data-value="èªåŒ">ğŸ˜Š èªåŒ</div>
                <div class="menu-btn rating-btn stance-btn ${ratingState.stance === 'å­˜ç–‘' ? 'selected' : ''}" data-value="å­˜ç–‘">ğŸ˜ å­˜ç–‘</div>
                <div class="menu-btn rating-btn stance-btn ${ratingState.stance === 'å¦èª' ? 'selected' : ''}" data-value="å¦èª">ğŸ˜  å¦èª</div>
            </div>`;
        
        let qualityHtml = '';
        if (ratingState.stance) {
            const tags = ['+ è­‰æ“šå……è¶³', '+ é‚è¼¯æ¸…æ™°', '- è¨´è«¸æƒ…æ„Ÿ', '- è­‰æ“šä¸è¶³'];
            qualityHtml = `
                <div class="grid grid-cols-2 gap-2">
                    ${tags.map(tag => `<div class="tag-btn quality-btn ${ratingState.quality.includes(tag) ? 'selected' : ''}" data-value="${tag}">${tag}</div>`).join('')}
                </div>
                <button id="complete-rating" class="w-full mt-2 bg-sky-600 text-white rounded-lg py-2 menu-btn">å®Œæˆ</button>`;
        }
        
        ratingMenu.innerHTML = stanceHtml + qualityHtml;
    };

    const completeRating = () => {
        const example = tutorialExamples[currentTutorialIndex];
        
        // FIX: Add a guard clause to handle cases where the current exercise is not a rating task.
        if (!example || !example.correct) {
            hideAllMenus();
            showInfoModal({
                title: 'æç¤º',
                bodyHtml: 'é€™å€‹ç·´ç¿’çš„ç›®æ¨™æ˜¯å­¸ç¿’ã€èˆ‰å ±å…§å®¹ã€‘ï¼Œè«‹å¾ [...] é¸å–®ä¸­é¸æ“‡å–”ï¼',
                footerHtml: `<button data-action="close" class="bg-sky-700 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-800">å¥½çš„</button>`
            });
            return;
        }

        const isCorrect = ratingState.stance === example.correct.stance && 
                          (example.correct.quality.length === 0 ||
                          (ratingState.quality.length === example.correct.quality.length &&
                           example.correct.quality.every(q => ratingState.quality.includes(q))));

        if (isCorrect) {
            hideAllMenus();
            if (example.type === 'rate-remove' && !example.rated) {
                example.rated = true;
                renderTutorialExample();
                return;
            }

            currentTutorialIndex++;
            
            if (currentTutorialIndex >= tutorialExamples.length) {
                 showInfoModal({
                    title: 'ç·´ç¿’å®Œæˆï¼',
                    bodyHtml: 'æ‚¨å·²ç†Ÿæ‚‰æ‰€æœ‰åŸºæœ¬çš„è©•åƒ¹æ“ä½œï¼',
                    footerHtml: `<button data-action="close" class="bg-sky-700 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-800">ç¹¼çºŒ</button>`,
                    onclose: () => showStep('step-5')
                });
            } else {
                renderTutorialExample();
            }
        } else {
            const correctStance = example.correct.stance;
            const correctQuality = example.correct.quality.join('ã€');
            let bodyHtml = `é€™å€‹ç·´ç¿’çš„ç›®æ¨™æ˜¯å­¸ç¿’åˆ¤æ–·å…§å®¹çš„å“è³ªã€‚è«‹è©¦è‘—é¸æ“‡ã€${correctStance}ã€‘`;
            if (correctQuality) bodyHtml += `ï¼Œä¸¦ç‚ºå®ƒåŠ ä¸Šã€${correctQuality}ã€‘çš„æ¨™ç±¤ã€‚`;
            else bodyHtml += `ã€‚`;
            showInfoModal({
                title: 'å†è©¦ä¸€æ¬¡ï¼', bodyHtml,
                footerHtml: `<button data-action="close" class="bg-sky-700 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-800">å¥½çš„ï¼Œå†è©¦ä¸€æ¬¡</button>`
            });
        }
    };

    // --- å…¨åŸŸäº‹ä»¶ç›£è½ ---
    nextButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const nextStepId = btn.dataset.next;
            showStep(nextStepId);
            if (nextStepId === 'step-1') {
                choiceB.classList.remove('selected');
                currentTutorialIndex = 0;
                tutorialExamples.forEach(ex => ex.rated = false);
            }
        });
    });

    choiceA.addEventListener('click', showFloodingEffect);
    choiceB.addEventListener('click', () => {
        choiceB.classList.add('selected');
        setTimeout(() => showStep('step-3'), 800);
    });

    document.body.addEventListener('click', (e) => {
        if (menuJustOpened) {
            menuJustOpened = false;
            return;
        }

        if (!contextMenu.contains(e.target) && !ratingMenu.contains(e.target) && !e.target.closest('.more-options-btn')) {
            hideAllMenus();
        }

        const target = e.target.closest('.menu-btn, .quality-btn');
        if (!target) return;

        e.stopPropagation();

        if (contextMenu.contains(target)) {
            const action = target.dataset.action;
            hideAllMenus();

            if (action === 'rate') {
                triggerMenu('rating', document.getElementById('rating-card'));
            } else if (action === 'report') {
                const example = tutorialExamples[currentTutorialIndex];
                if (example.type === 'report') {
                    showInfoModal({
                        title: 'ç¢ºèªèˆ‰å ±ï¼Ÿ',
                        bodyHtml: 'æ‚¨ç¢ºå®šè¦èˆ‰å ±æ­¤å…§å®¹é•åç¤¾ç¾¤è¦ç¯„å—ï¼Ÿ',
                        footerHtml: `<button id="confirm-report-btn" data-action="close" class="bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-700">ç¢ºèªèˆ‰å ±</button>
                                     <button data-action="close" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-300">å–æ¶ˆ</button>`,
                    });
                    document.getElementById('confirm-report-btn').addEventListener('click', () => {
                        showInfoModal({
                           title: 'æ„Ÿè¬æ‚¨çš„èˆ‰å ±',
                           bodyHtml: 'æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„å›å ±ã€‚æ„Ÿè¬æ‚¨ä¸€åŒç¶­è­·ç¤¾ç¾¤çš„å¥åº·ç’°å¢ƒï¼',
                           footerHtml: `<button data-action="close" class="bg-sky-700 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-800">å®Œæˆæ‰€æœ‰ç·´ç¿’</button>`,
                           onclose: () => showStep('step-5')
                        });
                    }, { once: true });
                } else {
                     showInfoModal({ title: 'æç¤º', bodyHtml: 'é€™å‰‡å…§å®¹ä¼¼ä¹æ²’æœ‰é•åç¤¾ç¾¤è¦ç¯„ï¼Œè«‹å…ˆç·´ç¿’å…¶ä»–æ“ä½œå–”ï¼', footerHtml: `<button data-action="close" class="bg-sky-700 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-800">å¥½çš„</button>` });
                }
            } else if (action === 'remove') {
                const example = tutorialExamples[currentTutorialIndex];
                if (example.type === 'rate-remove' && example.rated) {
                    showInfoModal({
                        title: 'ç¢ºèªç§»é™¤ï¼Ÿ',
                        bodyHtml: 'æ‚¨ç¢ºå®šè¦ç§»é™¤æ‚¨çš„è©•åƒ¹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚',
                        footerHtml: `<button id="confirm-remove-btn" data-action="close" class="bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-700">ç¢ºèªç§»é™¤</button>
                                     <button data-action="close" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-300">å–æ¶ˆ</button>`,
                    });
                    document.getElementById('confirm-remove-btn').addEventListener('click', () => {
                        currentTutorialIndex++;
                        renderTutorialExample();
                    }, { once: true });
                } else {
                    showInfoModal({ title: 'æç¤º', bodyHtml: 'æ‚¨å°šæœªå°æ­¤è§€é»åšå‡ºè©•åƒ¹ï¼Œæˆ–ç¾åœ¨ä¸æ˜¯ç§»é™¤è©•åƒ¹çš„ç·´ç¿’æ­¥é©Ÿå–”ã€‚', footerHtml: `<button data-action="close" class="bg-sky-700 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-800">å¥½çš„</button>` });
                }
            }
        }

        if (ratingMenu.contains(target)) {
            if (target.matches('.stance-btn')) {
                ratingState.stance = target.dataset.value;
                if (tutorialExamples[currentTutorialIndex].type === 'rate-remove' && !tutorialExamples[currentTutorialIndex].rated) {
                    completeRating();
                } else {
                    renderRatingMenu();
                }
            } else if (target.matches('.quality-btn')) {
                const value = target.dataset.value;
                const index = ratingState.quality.indexOf(value);
                if (index > -1) ratingState.quality.splice(index, 1);
                else ratingState.quality.push(value);
                renderRatingMenu();
            } else if (target.id === 'complete-rating') {
                completeRating();
            }
        }
    });

    // åˆå§‹åŒ–
    showStep('step-1');
});
</script>

</body>
</html>
